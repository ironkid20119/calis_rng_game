<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>calis rng</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Balthazar:wght@400;700&display=swap');

      body {
        font-family: 'Balthazar', serif;
        margin: 0;
        padding: 0;
        background: #6a0dad;
        color: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
      }

      .game-container {
        background: #2c2c2c;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        min-width: 350px;
        max-width: 900px;
      }

      button {
        padding: 10px 20px;
        margin: 5px;
        font-size: 16px;
        cursor: pointer;
        background-color: #c71585;
        color: #fff;
        border: none;
        border-radius: 5px;
        transition: background-color 0.3s;
        font-family: 'Balthazar', serif;
        font-weight: 700;
      }

      button:disabled {
        background-color: #555;
        cursor: not-allowed;
      }

      button:hover:not(:disabled) {
        background-color: #e754bb;
      }

      #results {
        margin-top: 20px;
        white-space: pre-line;
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 5px;
        min-height: 100px;
        font-family: 'Balthazar', serif;
      }

      .bold {
        font-weight: 700;
      }

      .roll-line {
        margin: 5px 0;
      }

      .rank-button {
        background: none;
        border: 2px solid #28a745;
        color: inherit;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 3px;
        font-family: 'Balthazar', serif;
        transition: all 0.2s;
        display: inline;
      }

      .rank-button:hover {
        background-color: rgba(40, 167, 69, 0.2);
        border-color: #34d058;
      }

      .rank-button.accepted {
        opacity: 0.3;
        cursor: default;
        border-color: #555;
      }

      .rank-button.accepted:hover {
        background: none;
        border-color: #555;
      }

      .inventory-section {
        margin-top: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      }

      .inventory-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 5px;
        margin-top: 15px;
      }

      .inventory-slot {
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid #555;
        border-radius: 5px;
        padding: 5px;
        min-height: 40px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .inventory-slot:hover {
        background: rgba(0, 0, 0, 0.5);
        border-color: #888;
      }

      .inventory-slot.empty {
        cursor: default;
        opacity: 0.5;
      }

      .inventory-slot.empty:hover {
        background: rgba(0, 0, 0, 0.3);
        border-color: #555;
      }

      .slot-variants {
        font-size: 8px;
        margin-bottom: 2px;
        color: #ffd700;
      }

      .slot-value {
        font-weight: 700;
        margin-bottom: 2px;
        font-size: 9px;
      }

      .slot-rank {
        font-size: 9px;
        opacity: 0.8;
      }

      .index-section {
        margin-top: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        max-height: 500px;
        overflow-y: auto;
      }

      .index-category {
        margin-bottom: 20px;
        text-align: left;
      }

      .index-category h3 {
        margin-bottom: 10px;
        color: #c71585;
      }

      .index-item {
        padding: 5px;
        margin: 3px 0;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
      }

      .index-item.discovered {
        color: #4ade80;
      }

      .index-item.undiscovered {
        color: #666;
      }

      #toggleIndex {
        margin-top: 10px;
        background-color: #6a0dad;
      }

      #toggleIndex:hover {
        background-color: #8a2dcd;
      }

      #toggleShop {
        margin-top: 10px;
        background-color: #d4af37;
        color: #000;
      }

      #toggleShop:hover {
        background-color: #f0c748;
      }

      #toggleCooldownSettings {
        background-color: #3b82f6;
      }

      #toggleCooldownSettings:hover {
        background-color: #60a5fa;
      }

      #toggleSellMode {
        background-color: #ff6b35;
      }

      #toggleSellMode:hover {
        background-color: #ff8555;
      }

      #toggleSellMode.active {
        background-color: #ff3333;
      }

      .shop-section {
        margin-top: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      }

      .coins-display {
        font-size: 24px;
        font-weight: 700;
        color: #d4af37;
        margin-bottom: 20px;
      }
      
      /* NEW STYLE FOR GEOMETRIX */
      .geometrix-display {
        color: #15f4ee; /* Cyan/Aqua color for Geometrix */
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 20px;
      }

      .shop-item {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        border: 2px solid #555;
      }

      .shop-item h4 {
        margin: 0 0 10px 0;
        color: #fff;
      }

      .shop-item p {
        margin: 5px 0;
        font-size: 14px;
      }

      .shop-item button {
        margin-top: 10px;
        background-color: #d4af37;
        color: #000;
      }

      .shop-item button:hover:not(:disabled) {
        background-color: #f0c748;
      }

      .shop-item button:disabled {
        background-color: #555;
        color: #888;
      }

      .maxed {
        color: #4ade80;
        font-weight: 700;
      }

      .roll-counter {
        margin-bottom: 15px;
        font-size: 18px;
        color: #d4af37;
      }

      #toggleMerchant {
        background-color: #4ade80;
        color: #000;
      }

      #toggleMerchant:hover {
        background-color: #5ef090;
      }

      #toggleItemInventory {
        background-color: #a855f7;
      }

      #toggleItemInventory:hover {
        background-color: #b865ff;
      }

      .merchant-section {
        margin-top: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      }

      .merchant-timer {
        font-size: 16px;
        color: #4ade80;
        margin-bottom: 15px;
      }

      .merchant-items {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        max-height: 400px;
        overflow-y: auto;
      }

      .merchant-item {
        background: rgba(0, 0, 0, 0.4);
        padding: 15px;
        border-radius: 5px;
        border: 2px solid #4ade80;
      }

      .merchant-item h4 {
        margin: 0 0 10px 0;
        color: #4ade80;
      }

      .item-inventory-section {
        margin-top: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      }

      .item-slot {
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid #a855f7;
        border-radius: 5px;
        padding: 10px;
        min-height: 50px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
      }

      .item-slot:hover {
        background: rgba(0, 0, 0, 0.5);
        border-color: #b865ff;
      }

      .item-slot.empty {
        cursor: default;
        opacity: 0.5;
      }

      .item-slot.empty:hover {
        background: rgba(0, 0, 0, 0.3);
        border-color: #a855f7;
      }

      .item-name {
        font-weight: 700;
        font-size: 12px;
        margin-bottom: 5px;
      }

      .item-multiplier {
        font-size: 10px;
        color: #ffd700;
      }

      #togglePVP {
        background-color: #ef4444;
      }

      #togglePVP:hover {
        background-color: #ff5555;
      }

      #toggleCurses {
        background-color: #7c3aed;
      }

      #toggleCurses:hover {
        background-color: #8b5cf6;
      }
      
      #toggleShapes { /* NEW BUTTON STYLE */
        background-color: #15f4ee;
        color: #000;
      }
      
      #toggleShapes:hover {
        background-color: #38f8f8;
      }

      .pvp-section {
        margin-top: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      }

      .pvp-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 20px;
      }

      .pvp-stat {
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 5px;
        border: 2px solid #ef4444;
      }

      .pvp-stat h4 {
        margin: 0 0 5px 0;
        color: #ef4444;
      }

      .pvp-results {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px;
        border-radius: 5px;
        margin-top: 15px;
        min-height: 100px;
      }

      .pvp-upgrades {
        margin-top: 20px;
      }

      .curses-section {
        margin-top: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      }
      
      /* NEW SHAPES SECTION STYLE */
      .shapes-section {
        margin-top: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        border: 2px solid #15f4ee;
      }
      
      .shapes-upgrades {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin-top: 15px;
      }

      .curse-item {
        background: rgba(0, 0, 0, 0.4);
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        border: 2px solid #7c3aed;
      }

      .curse-item.active {
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.2);
      }

      .curse-item h4 {
        margin: 0 0 10px 0;
        color: #7c3aed;
      }

      .curse-item.active h4 {
        color: #ef4444;
      }

      #rollSpecialLuck {
        background-color: #f59e0b;
      }

      #rollSpecialLuck:hover:not(:disabled) {
        background-color: #fbbf24;
      }

      .music-control {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px;
        border-radius: 10px;
        border: 2px solid #c71585;
      }

      .music-control button {
        padding: 5px 10px;
        font-size: 12px;
        margin: 2px;
      }

      .music-status {
        font-size: 10px;
        margin-bottom: 5px;
        color: #4ade80;
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <h1>calis rng game</h1>
      <p style="color: #fbbf24; font-size: 12px; margin: 10px 0;">i suggest you don't spam roll if you just started! only do it when you have the 'Calis Blessing' upgrade - cali</p>
      <div class="roll-counter">
        Total Rolls: <span id="rollCounter">0</span>
      </div>
      <button id="rollOnceBtn">Roll Once</button>
      <button id="rollMultipleBtn">Roll 15 Times</button>
      <button id="rollSpecialLuck">Roll Once (x10000 Special Luck)</button>
      <button id="toggleInventory">Toggle Inventory</button>
      <button id="toggleIndex">Toggle Index</button>
      <button id="toggleShop">Toggle Shop</button>
      <button id="toggleMerchant">Toggle Merchant</button>
      <button id="toggleItemInventory">Toggle Item Inventory</button>
      <button id="togglePVP">Toggle PVP</button>
      <button id="toggleCurses">Toggle Curses</button>
      <button id="toggleShapes" style="background-color: #15f4ee; color: #000;">Toggle Shapes</button> <button id="toggleCooldownSettings">Cooldown Settings</button>
      <button id="toggleSellMode">Sell Mode: OFF</button>

      <div id="results"></div>

      <div class="inventory-section" id="inventorySection" style="display: none;">
        <h2>Inventory (<span id="inventoryCount">0</span>/<span id="maxSlotsDisplay">250</span> slots)</h2>
        <div class="inventory-grid" id="inventoryGrid"></div>
      </div>

      <div class="shop-section" id="shopSection" style="display: none;">
        <h2>Shop</h2>
        <div class="coins-display">Cali-coins: <span id="coinsDisplay">0</span></div>
        <div id="shopContent"></div>
      </div>

      <div class="merchant-section" id="merchantSection" style="display: none;">
        <h2>Merchant</h2>
        <div class="coins-display">Cali-coins: <span id="merchantCoinsDisplay">0</span></div>
        <div class="merchant-timer">Next restock in: <span id="merchantTimer">30</span>s</div>
        <div class="merchant-items" id="merchantItems"></div>
      </div>

      <div class="item-inventory-section" id="itemInventorySection" style="display: none;">
        <h2>Item Inventory (<span id="itemInventoryCount">0</span>/50 slots)</h2>
        <div class="inventory-grid" id="itemInventoryGrid"></div>
      </div>

      <div class="pvp-section" id="pvpSection" style="display: none;">
        <h2>PVP Arena</h2>
        <div class="pvp-stats">
          <div class="pvp-stat">
            <h4>PVP Coins</h4>
            <p id="pvpCoinsDisplay">0</p>
          </div>
          <div class="pvp-stat">
            <h4>Win Streak</h4>
            <p id="winStreakDisplay">0</p>
          </div>
          <div class="pvp-stat">
            <h4>Total Wins</h4>
            <p id="totalWinsDisplay">0</p>
          </div>
        </div>
        <button id="pvpRollBtn">Roll Against Opponent</button>
        <div class="pvp-results" id="pvpResults"></div>
        <div class="pvp-upgrades">
          <h3>PVP Upgrades</h3>
          <div id="pvpUpgradesContent"></div>
        </div>
      </div>

      <div class="curses-section" id="cursesSection" style="display: none;">
        <h2>Curses</h2>
        <div class="coins-display">Cali-coins: <span id="cursesCoinsDisplay">0</span></div>
        <p style="color: #fbbf24; margin-bottom: 15px;">Only ONE curse can be active at a time. Costs 16.66% of current coins to unequip.</p>
        <div id="cursesContent"></div>
      </div>
      
      <div class="shapes-section" id="shapesSection" style="display: none;">
        <h2>Shapes - Geometrix Game</h2>
        <div class="geometrix-display">Geometrix: <span id="geometrixDisplay">0</span></div>
        
        <button id="unlockShapesBtn" onclick="unlockShapes()" style="margin-bottom: 15px;">
            Unlock Shapes (Cost: <span style="color: gold;">1e40 Cali-coins</span>)
        </button>
        
        <div id="shapesGameArea" style="display: none;">
            <p style="font-size: 16px;">Shapes spawn in: <span id="polygonCooldown">2.000</span>s</p>
            <p>Last Spawn: <span id="lastShapeDisplay">None</span> | Last Geometrix Gain: <span id="lastGeometrixGain">0</span></p>
            
            <hr>
            
            <h3>Geometrix Upgrades</h3>
            <div class="shapes-upgrades" id="polygonUpgrades">
                <div class="shop-item">
                    <h4>Shape Luck (+0.1x Luck)</h4>
                    <p>Current: <span id="shapeLuckLevel">0</span>/5</p>
                    <p>Cost: <span id="shapeLuckCost">5</span> Geometrix</p>
                    <button onclick="buyShapeUpgrade(1)" id="buyShapeLuckBtn">Buy</button>
                </div>
                
                <div class="shop-item">
                    <h4>Global Luck Multi (x2)</h4>
                    <p>Current: <span id="luckMultiLevel">0</span> levels</p>
                    <p>Cost: <span id="luckMultiCost">100</span> Geometrix</p>
                    <button onclick="buyShapeUpgrade(2)" id="buyLuckMultiBtn">Buy</button>
                </div>
                
                <div class="shop-item">
                    <h4>Bulk Spawn/Cooldown</h4>
                    <p>Current: <span id="bulkSpawnLevel">0</span>/4 (Spawn +0)</p>
                    <p>Cost: <span id="bulkSpawnCost">50</span> Geometrix</p>
                    <button onclick="buyShapeUpgrade(3)" id="buyBulkSpawnBtn">Buy</button>
                </div>
            </div>
        </div>
      </div>
      <div class="index-section" id="indexSection" style="display: none;">
        <h2>Discovery Index</h2>
        <div id="indexContent"></div>
      </div>

      <div class="index-section" id="cooldownSettingsSection" style="display: none;">
        <h2>Cooldown Settings</h2>
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 10px;">
            <input type="checkbox" id="enableSpecialCooldowns" checked> Enable cooldowns for special ranks
          </label>
          <label style="display: block; margin-bottom: 10px;">
            Value threshold for cooldowns (scientific notation supported):
            <input type="text" id="cooldownThreshold" value="1e35" style="margin-left: 10px; padding: 5px; width: 150px;">
          </label>
          <label style="display: block; margin-bottom: 10px;">
            Cooldown duration (seconds, 1-5):
            <input type="number" id="cooldownDuration" value="1.5" min="1" max="5" step="0.1" style="margin-left: 10px; padding: 5px; width: 100px;">
          </label>
          <div id="specialRankToggles" style="margin-top: 15px; max-height: 300px; overflow-y: auto;"></div>
          <button onclick="saveCooldownSettings()" style="margin-top: 10px;">Save Settings</button>
        </div>
      </div>
    </div>

    <div class="music-control">
      <div class="music-status" id="musicStatus">Music: Not Started</div>
      <button id="startMusic">Start Music</button>
      <button id="toggleMusic" style="display: none;">Pause</button>
      <button id="skipMusic" style="display: none;">Skip</button>
    </div>

    <script>
      const resultsDiv = document.getElementById('results');
      const rollOnceBtn = document.getElementById('rollOnceBtn');
      const rollMultipleBtn = document.getElementById('rollMultipleBtn');
      const rollSpecialLuckBtn = document.getElementById('rollSpecialLuck');
      const toggleInventoryBtn = document.getElementById('toggleInventory');
      const toggleIndexBtn = document.getElementById('toggleIndex');
      const toggleShopBtn = document.getElementById('toggleShop');
      const toggleMerchantBtn = document.getElementById('toggleMerchant');
      const toggleItemInventoryBtn = document.getElementById('toggleItemInventory');
      const togglePVPBtn = document.getElementById('togglePVP');
      const toggleCursesBtn = document.getElementById('toggleCurses');
      const toggleShapesBtn = document.getElementById('toggleShapes'); // NEW
      const toggleCooldownSettingsBtn = document.getElementById('toggleCooldownSettings');
      const toggleSellModeBtn = document.getElementById('toggleSellMode');
      const inventorySection = document.getElementById('inventorySection');
      const indexSection = document.getElementById('indexSection');
      const shopSection = document.getElementById('shopSection');
      const merchantSection = document.getElementById('merchantSection');
      const itemInventorySection = document.getElementById('itemInventorySection');
      const pvpSection = document.getElementById('pvpSection');
      const cursesSection = document.getElementById('cursesSection');
      const shapesSection = document.getElementById('shapesSection'); // NEW
      const cooldownSettingsSection = document.getElementById('cooldownSettingsSection');
      const pvpRollBtn = document.getElementById('pvpRollBtn');
      const indexContent = document.getElementById('indexContent');
      const shopContent = document.getElementById('shopContent');
      const merchantItems = document.getElementById('merchantItems');
      const itemInventoryGrid = document.getElementById('itemInventoryGrid');
      const pvpResults = document.getElementById('pvpResults');
      const pvpUpgradesContent = document.getElementById('pvpUpgradesContent');
      const cursesContent = document.getElementById('cursesContent');
      const coinsDisplay = document.getElementById('coinsDisplay');
      const merchantCoinsDisplay = document.getElementById('merchantCoinsDisplay');
      const cursesCoinsDisplay = document.getElementById('cursesCoinsDisplay');
      const inventoryCountDisplay = document.getElementById('inventoryCount');
      const itemInventoryCountDisplay = document.getElementById('itemInventoryCount');
      const maxSlotsDisplay = document.getElementById('maxSlotsDisplay');
      const inventoryGrid = document.getElementById('inventoryGrid');
      const rollCounterDisplay = document.getElementById('rollCounter');
      const merchantTimer = document.getElementById('merchantTimer');
      const pvpCoinsDisplay = document.getElementById('pvpCoinsDisplay');
      const winStreakDisplay = document.getElementById('winStreakDisplay');
      const totalWinsDisplay = document.getElementById('totalWinsDisplay');
      const startMusicBtn = document.getElementById('startMusic');
      const toggleMusicBtn = document.getElementById('toggleMusic');
      const skipMusicBtn = document.getElementById('skipMusic');
      const musicStatus = document.getElementById('musicStatus');
      
      // NEW SHAPES UI ELEMENTS
      const geometrixDisplay = document.getElementById('geometrixDisplay');
      const unlockShapesBtn = document.getElementById('unlockShapesBtn');
      const shapesGameArea = document.getElementById('shapesGameArea');
      const polygonCooldownDisplay = document.getElementById('polygonCooldown');
      const lastShapeDisplay = document.getElementById('lastShapeDisplay');
      const lastGeometrixGainDisplay = document.getElementById('lastGeometrixGain');
      const shapeLuckLevelDisplay = document.getElementById('shapeLuckLevel');
      const shapeLuckCostDisplay = document.getElementById('shapeLuckCost');
      const luckMultiLevelDisplay = document.getElementById('luckMultiLevel');
      const luckMultiCostDisplay = document.getElementById('luckMultiCost');
      const bulkSpawnLevelDisplay = document.getElementById('bulkSpawnLevel');
      const bulkSpawnCostDisplay = document.getElementById('bulkSpawnCost');

      // NEW SHAPE CONSTANTS
      const UNLOCK_SHAPES_COST = 1e40;
      const SHAPE_COOLDOWN_BASE = 2.0;
      const GAME_TICK_RATE = 100; // 100ms
      
      // Shape definition based on user-provided ratios (1/X is the chance)
      // Triangle: 1/2 (Weight 250)
      // Square: 1/5 (Weight 100)
      // Pentagon: 1/10 (Weight 50)
      // Hexagon: 1/25 (Weight 20)
      // 7-sided Polygon: 1/50 (Weight 10)
      // Octagon: 1/100 (Weight 5)
      // Circle: 1/500 (Weight 1)
      const SHAPES = [
          { name: 'Triangle', weight: 250, rarity: 1.7442, isCircle: false, color: 'lime' }, 
          { name: 'Square', weight: 100, rarity: 4.3605, isCircle: false, color: 'blue' }, 
          { name: 'Pentagon', weight: 50, rarity: 8.7211, isCircle: false, color: 'cyan' }, 
          { name: 'Hexagon', weight: 20, rarity: 21.8027, isCircle: false, color: 'yellow' }, 
          { name: '7-sided Polygon', weight: 10, rarity: 43.6055, isCircle: false, color: 'orange' }, 
          { name: 'Octagon', weight: 5, rarity: 87.2110, isCircle: false, color: 'red' }, 
          { name: 'Circle', weight: 1, rarity: 436, isCircle: true, color: 'gold' }, 
      ];
      const TOTAL_SHAPE_WEIGHT = 436; // Sum of weights: 250+100+50+20+10+5+1

      let isCooldown = false;
      let isPVPCooldown = false;
      let multiRolls = [];
      let inventory = [];
      let itemInventory = [];
      let discovered = { ranks: [], specialRanks: [], secretRanks: [], variantSecrets: [], variants: [] };
      let caliCoins = 0;
      let maxSlots = 250;
      let sellExponent = 0.33;
      let rollBulk = 15;
      let variantLuckBonus = 1;
      let availabilityUnlocked = false;
      let totalRolls = 0;
      let calisBlessingActive = false;
      let blessingBoosterActive = false;
      let secretLuckBonus = 1;
      let specialLuckBonus = 1;
      let generalLuckBonus = 1;
      let merchantTimeLeft = 30;
      let merchantStock = [];
      let pvpCoins = 0;
      let winStreak = 0;
      let totalWins = 0;
      let rngExponent = 1;
      let activeCurse = null;
      let cursesUnlocked = false;
      let yinYangState = 'normal';
      let yinYangTimer = 60;
      let playedSongs = [];
      let currentAudio = null;
      let musicPaused = false;
      let musicStarted = false;
      let nullDisplayIndex = 0;
      const nullDisplayValues = ["0", "null", "-404", "-503", "[Label Missing]"];
      
      // NEW SHAPE STATE VARIABLES
      let geometrix = 0;
      let shapesUnlocked = false;
      let shapeLuckLevel = 0; // Max 5
      let luckMultiLevel = 0; // No Max
      let bulkSpawnLevel = 0; // Max 4
      let polygonCooldownRemaining = SHAPE_COOLDOWN_BASE;
      let lastShape = 'None';
      let lastGeometrixGain = 0;
      
      let cooldownSettings = {
        specialRanks: {},
        threshold: 1e35,
        duration: 1.5
      };
      
      const ALL_SPECIAL_RANKS = ['In im table ?!?!?', '???UNKNOWN???', 'leaflet', 'nil', 'NOTHINGNESS', 'INSANE', 'Lmao', 'PERFECTIONIST', 'Imaginary', 'NICE', 'FUNNY', 'Common : DIVINITY', 'Legacy FINALE', 'Catastrophic', '<(ETERNAL DAWN)>', 'UNOBTAINABLE', 'Everlasting', 'RNGod', 'Invisible', 'cali', 'RNGarbage', 'Cheesium', 'pepeCringe', 'EZ', 'The Great Special Rank With An Unnecessary Long Name, Anyways Are You Even Reading This? I Bet Not. If You Are Good Job Cuz You Wasted Time On This, Why? Anyways, Be Happy You Rolled This. Its The Rarest Special Rank. Haha I Am Making You Read This Weird Rank Name Anyways So What? Its Just A RNG Game Rank Anyways  Just Stop. You Did Too Much Reading For A Simple RNG Game Bro I Am Telling You Stop Its Just A Rank Of All Things', '100', 'NULL', '[Title Label Missing]'];
      
      ALL_SPECIAL_RANKS.forEach(rank => {
        cooldownSettings.specialRanks[rank] = true;
      });
      
      let shopUpgrades = {
        variantLuck: 0,
        rollBulk: 0,
        secretLuck: 0,
        specialLuck: 0,
        generalLuck: 0,
        sellPower: 0,
        availability: false,
        calisBlessing: false,
        blessingBooster: false,
        extraAvailability: false
      };
      
      let pvpUpgrades = {
        bulkRoll: 0,
        rngExponent: 0
      };
      
      const CURSES = {
        greed: {
          name: 'Greed',
          description: 'x5 PVP coins and Cali-coins gain, but divide all luck by 10',
          pvpCost: 250
        },
        cursedMultiplier: {
          name: 'Cursed Multiplier',
          description: 'Every booster is x5 better, but 1/2.5 chance to ruin roll (gives 1.01 with no variants)',
          pvpCost: 250
        },
        yinYang: {
          name: 'Yin-Yang',
          description: 'Every minute, switches between x100 normal luck/x0 special and x0 normal/x100,000 special',
          pvpCost: 500
        }
      };
      
      let lastClickTime = {};
      let sellMode = false;

      const ALL_RANKS = ['nothing', 'Common', 'Natural', 'Rare', 'Unnatural', 'Epic', 'Decent', 'Mythical', 'Legendary', 'Unreal', 'Super Rare', 'Eternal', 'Starstruck', 'Paradoxical', 'Iridescent', 'Lux', 'Possible', 'RNGesus', 'CRAZY', 'Supreme', 'DAMN', 'Stupiditium', 'ASCENDED', 'Obscure', 'INFINITE', 'Divine', 'Insurmountable', 'GRAND', 'what.', 'FINALE', 'Microb', 'Attainable', 'Directional', 'Limitless', 'Endless'];
      
      const ALL_SECRET_RANKS = ['üêü', 'Destiny', 'üå≥', 'ULTIMATE'];
      
      const ALL_VARIANT_SECRETS = ['(Existance)', 'COLOSSAL'];
      
      const ALL_VARIANTS = ['shiny', 'golden', 'inverse', 'retro', 'bright', 'cosmic', 'GIGANTIC', 'h o r s e', 'eternal', 'dark', 'UNIVERSAL', 'Modified', 'Colorful', 'Gigaconfuscibretrationiminousis', 'Possible', 'Gargantuan', 'Ethereal', 'Limitless', 'INFINITUM', 'evil', 'Light', 'void.', 'Unhonored', 'REALITY'];

      // --- HELPER FUNCTIONS ---
      function formatNumber(num) {
        if (num === Infinity) return 'Infinity';
        if (num === 0) return '0';
        if (num < 1000) return Math.floor(num).toString();
        
        let exponent = Math.floor(Math.log10(num));
        let mantissa = num / Math.pow(10, exponent);
        
        if (exponent < 3) return Math.floor(num).toString();
        
        return mantissa.toFixed(2).replace(/\.?0*$/, '') + 'e' + exponent;
      }
      
      function getNonPolygonLuckMulti() {
        // Multiplier from the Geometrix Upgrade (x2 multiplicative per level)
        return Math.pow(2, luckMultiLevel);
      }

      function getShapeUpgradeCost(upgradeId, level) {
          if (upgradeId === 1) { // Shape Luck (5 * 1.75^level, flat number)
              return 5 * Math.pow(1.75, level);
          } else if (upgradeId === 2) { // Non-Polygon Luck Multi (100 * 1000^level)
              return 100 * Math.pow(1000, level);
          } else if (upgradeId === 3) { // Bulk Spawn (50 * 5^level)
              return 50 * Math.pow(5, level);
          }
          return Infinity;
      }

      // --- NEW SHAPES GAME LOGIC ---

      window.unlockShapes = function() {
          if (shapesUnlocked) return;
          if (caliCoins < UNLOCK_SHAPES_COST) {
              alert('Not enough coins! You need ' + formatNumber(UNLOCK_SHAPES_COST) + ' Cali-coins.');
              return;
          }
          
          caliCoins -= UNLOCK_SHAPES_COST;
          shapesUnlocked = true;
          saveAll();
          renderShapes();
          updateCoinsDisplay();
      }

      window.buyShapeUpgrade = function(upgradeId) {
          let cost = 0;
          let level = 0;
          let maxLevel = Infinity;

          if (upgradeId === 1) { // Shape Luck
              level = shapeLuckLevel;
              maxLevel = 5;
              if (level >= maxLevel) {
                  alert('Max level reached for Shape Luck!');
                  return;
              }
          } else if (upgradeId === 2) { // Non-Polygon Luck Multi
              level = luckMultiLevel;
          } else if (upgradeId === 3) { // Bulk Spawn
              level = bulkSpawnLevel;
              maxLevel = 4;
              if (level >= maxLevel) {
                  alert('Max level reached for Bulk Spawn!');
                  return;
              }
          }
          
          cost = getShapeUpgradeCost(upgradeId, level);

          if (geometrix < cost) {
              alert('Not enough Geometrix! You need ' + formatNumber(cost) + ' Geometrix.');
              return;
          }

          geometrix -= cost;

          if (upgradeId === 1) shapeLuckLevel++;
          else if (upgradeId === 2) luckMultiLevel++;
          else if (upgradeId === 3) {
              bulkSpawnLevel++;
              // Recalculate and reset cooldown to apply new decreased time immediately
              const baseCooldown = SHAPE_COOLDOWN_BASE - (bulkSpawnLevel * 0.3333);
              polygonCooldownRemaining = Math.max(0.1, baseCooldown);
          }

          saveAll();
          renderShapes();
      }

      function spawnPolygon() {
          // Bulk Spawn calculation
          const bulkSpawnAmount = 1 + bulkSpawnLevel; 
          let totalGeometrixGained = 0;
          let lastShapeName = '';
          let lastShapeColor = 'white';
          
          // Shape Luck calculation
          const polygonLuck = 1 + (shapeLuckLevel * 0.1);

          for (let i = 0; i < bulkSpawnAmount; i++) {
              // Roll a number between 0 and TOTAL_SHAPE_WEIGHT
              const roll = Math.random() * TOTAL_SHAPE_WEIGHT; 
              let cumulativeWeight = 0;
              let spawnedShape = null;

              for (const shape of SHAPES) {
                  cumulativeWeight += shape.weight;
                  if (roll < cumulativeWeight) {
                      spawnedShape = shape;
                      break;
                  }
              }
              
              if (!spawnedShape) continue;
              
              lastShapeName = spawnedShape.name;
              lastShapeColor = spawnedShape.color;
              
              let geometrixGain = 0;
              if (spawnedShape.isCircle) {
                  // Formula for circle: Math.random() ** -1.5 (starts at 250) * luck
                  geometrixGain = 250 * Math.pow(Math.random(), -1.5) * polygonLuck;
              } else {
                  // Formula for others: (Actual rarity / 2) * luck
                  // Actual rarity = TOTAL_SHAPE_WEIGHT / Shape_Weight (which is pre-calculated as shape.rarity)
                  geometrixGain = (spawnedShape.rarity / 2) * polygonLuck;
              }

              totalGeometrixGained += geometrixGain;
          }
          
          if (totalGeometrixGained > 0) {
              geometrix += totalGeometrixGained;
              // Display consolidated result for bulk spawn
              const nameDisplay = bulkSpawnAmount > 1 ? 
                  `<span style="color: grey;">${bulkSpawnAmount} Shapes (Last: </span><span style="color: ${lastShapeColor};">${lastShapeName}</span><span style="color: grey;">)</span>` : 
                  `<span style="color: ${lastShapeColor};">${lastShapeName}</span>`;
              
              lastShape = nameDisplay;
              lastGeometrixGain = totalGeometrixGained;
          }

          // Reset cooldown
          const currentCooldown = SHAPE_COOLDOWN_BASE - (bulkSpawnLevel * 0.3333);
          polygonCooldownRemaining = Math.max(0.1, currentCooldown); // Set minimum practical cooldown

          saveAll();
          renderShapes(); // Immediate UI update after spawn
      }

      function renderShapes() {
          if (!shapesSection) return;

          unlockShapesBtn.style.display = shapesUnlocked ? 'none' : 'block';
          shapesGameArea.style.display = shapesUnlocked ? 'block' : 'none';
          
          if (!shapesUnlocked) {
              unlockShapesBtn.disabled = caliCoins < UNLOCK_SHAPES_COST;
              return;
          }
          
          // Update Geometrix Display
          geometrixDisplay.textContent = formatNumber(geometrix);
          
          // Update game status
          lastShapeDisplay.innerHTML = lastShape;
          lastGeometrixGainDisplay.textContent = formatNumber(lastGeometrixGain);
          polygonCooldownDisplay.textContent = Math.max(0, polygonCooldownRemaining).toFixed(3);
          
          // Update shape upgrades
          
          // 1. Shape Luck
          const luckCost = getShapeUpgradeCost(1, shapeLuckLevel);
          const luckMaxed = shapeLuckLevel >= 5;
          shapeLuckLevelDisplay.textContent = shapeLuckLevel;
          shapeLuckCostDisplay.textContent = formatNumber(luckCost);
          document.getElementById('buyShapeLuckBtn').textContent = luckMaxed ? 'MAXED' : 'Buy';
          document.getElementById('buyShapeLuckBtn').disabled = luckMaxed || geometrix < luckCost;
          
          // 2. Luck Multi
          const multiCost = getShapeUpgradeCost(2, luckMultiLevel);
          luckMultiLevelDisplay.textContent = luckMultiLevel;
          luckMultiCostDisplay.textContent = formatNumber(multiCost);
          document.getElementById('buyLuckMultiBtn').disabled = geometrix < multiCost;
          
          // 3. Bulk Spawn
          const bulkCost = getShapeUpgradeCost(3, bulkSpawnLevel);
          const bulkMaxed = bulkSpawnLevel >= 4;
          bulkSpawnLevelDisplay.textContent = bulkSpawnLevel;
          document.getElementById('buyBulkSpawnBtn').textContent = bulkMaxed ? 'MAXED' : 'Buy';
          bulkSpawnCostDisplay.textContent = formatNumber(bulkCost);
          document.getElementById('buyBulkSpawnBtn').disabled = bulkMaxed || geometrix < bulkCost;
          document.getElementById('bulkSpawnLevel').parentNode.querySelector('p:last-of-type').textContent = `Current: ${bulkSpawnLevel}/4 (Spawn +${bulkSpawnLevel})`;
      }

      // --- EXISTING GAME FUNCTIONS MODIFIED ---

      function initMusic() {
      }
      
      // ... (Music functions remain unchanged) ...

      function generateMerchantStock() {
        // ... (existing logic remains unchanged) ...
      }

      function renderMerchant() {
        // ... (existing logic remains unchanged) ...
      }

      window.buyMerchantItem = function(index) {
        // ... (existing logic remains unchanged) ...
      };

      function renderItemInventory() {
        // ... (existing logic remains unchanged) ...
      }

      function useItem(index) {
        // ... (existing logic remains unchanged) ...
      }
      
      // Placeholder for your complex rollOnce function. 
      // This function must be defined for the buttons to work!
      // I am assuming the full rollOnce function is already present in your environment/file.
      /*
      function rollOnce(rollCount, luckMultiplier, specialLuckMultiplier) {
        // ... (Your complex rolling logic here) ...
        return { 
          result: "ROLLINDEX", 
          cooldown: 0, 
          inventoryData: { rank: "Common", variants: [], value: 1.01 } 
        };
      }
      */
      
      // NOTE: Ensure your existing rollOnce function uses getNonPolygonLuckMulti()
      // to correctly apply the new x2 luck multiplier:
      // const globalLuckMulti = getNonPolygonLuckMulti();
      // ... (apply globalLuckMulti to relevant luck values) ...


      // --- UI TOGGLE MODIFICATION ---
      const ALL_SECTIONS = [inventorySection, indexSection, shopSection, merchantSection, itemInventorySection, pvpSection, cursesSection, cooldownSettingsSection, shapesSection];

      function toggleSection(section) {
          ALL_SECTIONS.forEach(s => {
              if (s !== section) {
                  s.style.display = 'none';
              }
          });
          if (section.style.display === 'none') {
              section.style.display = 'block';
              if (section === inventorySection) renderInventory();
              if (section === indexSection) renderIndex();
              if (section === shopSection) renderShop();
              if (section === merchantSection) renderMerchant();
              if (section === itemInventorySection) renderItemInventory();
              if (section === pvpSection) { renderPVPUpgrades(); updatePVPDisplay(); }
              if (section === cursesSection) renderCurses();
              if (section === cooldownSettingsSection) loadCooldownSettings();
              if (section === shapesSection) renderShapes(); // NEW CALL
          } else {
              section.style.display = 'none';
          }
      }

      toggleInventoryBtn.addEventListener('click', () => toggleSection(inventorySection));
      toggleIndexBtn.addEventListener('click', () => toggleSection(indexSection));
      toggleShopBtn.addEventListener('click', () => toggleSection(shopSection));
      toggleMerchantBtn.addEventListener('click', () => toggleSection(merchantSection));
      toggleItemInventoryBtn.addEventListener('click', () => toggleSection(itemInventorySection));
      togglePVPBtn.addEventListener('click', () => toggleSection(pvpSection));
      toggleCursesBtn.addEventListener('click', () => toggleSection(cursesSection));
      toggleCooldownSettingsBtn.addEventListener('click', () => toggleSection(cooldownSettingsSection));
      toggleShapesBtn.addEventListener('click', () => toggleSection(shapesSection)); // NEW TOGGLE
      
      // ... (rest of the toggle/render functions remain unchanged) ...

      function renderShop() {
        // ... (existing logic remains unchanged) ...
      }

      window.buyUpgrade = function(type) {
        // ... (existing logic remains unchanged) ...
      };

      function loadInventory() {
        // ... (existing logic remains unchanged) ...
      }
      
      // --- SAVE/LOAD MODIFICATION ---

      function loadShopData() {
        const saved = localStorage.getItem('calisRngShop');
        if (saved) {
          try {
            const data = JSON.parse(saved);
            caliCoins = data.coins || 0;
            totalRolls = data.totalRolls || 0;
            pvpCoins = data.pvpCoins || 0;
            winStreak = data.winStreak || 0;
            totalWins = data.totalWins || 0;
            itemInventory = data.itemInventory || [];
            activeCurse = data.activeCurse || null;
            cursesUnlocked = data.cursesUnlocked || false;

            // Load Existing Upgrades
            shopUpgrades = data.upgrades || shopUpgrades;
            pvpUpgrades = data.pvpUpgrades || pvpUpgrades;
            variantLuckBonus = 1 + ((shopUpgrades.variantLuck || 0) * 0.1);
            rollBulk = 15 + ((shopUpgrades.rollBulk || 0) * 10);
            secretLuckBonus = 1 + ((shopUpgrades.secretLuck || 0) * 0.1);
            specialLuckBonus = 1 + ((shopUpgrades.specialLuck || 0) * 0.1);
            generalLuckBonus = 1 + ((shopUpgrades.generalLuck || 0) * 0.05);
            rngExponent = 1 + ((pvpUpgrades.rngExponent || 0) * 0.1);
            
            // Load NEW SHAPE DATA
            geometrix = data.geometrix || 0;
            shapesUnlocked = data.shapesUnlocked || false;
            shapeLuckLevel = data.shapeLuckLevel || 0;
            luckMultiLevel = data.luckMultiLevel || 0;
            bulkSpawnLevel = data.bulkSpawnLevel || 0;
            lastShape = data.lastShape || 'None';
            lastGeometrixGain = data.lastGeometrixGain || 0;
            
            // Recalculate Cooldown based on bulkSpawnLevel
            const currentCooldown = SHAPE_COOLDOWN_BASE - (bulkSpawnLevel * 0.3333);
            polygonCooldownRemaining = Math.max(0.1, currentCooldown);

            // Existing post-load adjustments
            shopUpgrades.extraAvailability = shopUpgrades.extraAvailability || false;
            availabilityUnlocked = shopUpgrades.availability || false;
            calisBlessingActive = shopUpgrades.calisBlessing || false;
            blessingBoosterActive = shopUpgrades.blessingBooster || false;
          } catch (e) {
            console.error('Failed to load shop data', e);
          }
        }
        updateCoinsDisplay();
        updateRollCounter();
        updatePVPDisplay();
        renderInventory();
        renderItemInventory();
      }

      function saveAll() {
        localStorage.setItem('calisRngInventory', JSON.stringify(inventory));
        const shopData = {
          coins: caliCoins,
          totalRolls: totalRolls,
          upgrades: shopUpgrades,
          pvpCoins: pvpCoins,
          winStreak: winStreak,
          totalWins: totalWins,
          pvpUpgrades: pvpUpgrades,
          itemInventory: itemInventory,
          activeCurse: activeCurse,
          cursesUnlocked: cursesUnlocked,
          
          // NEW SHAPE PROPERTIES
          geometrix: geometrix,
          shapesUnlocked: shapesUnlocked,
          shapeLuckLevel: shapeLuckLevel,
          luckMultiLevel: luckMultiLevel,
          bulkSpawnLevel: bulkSpawnLevel,
          lastShape: lastShape,
          lastGeometrixGain: lastGeometrixGain,
        };
        localStorage.setItem('calisRngShop', JSON.stringify(shopData));
        updateCoinsDisplay();
        updateRollCounter();
        updatePVPDisplay();
        renderInventory();
        renderItemInventory();
      }

      function updateCoinsDisplay() {
        coinsDisplay.textContent = formatNumber(caliCoins); // Use formatNumber
        merchantCoinsDisplay.textContent = formatNumber(caliCoins); // Use formatNumber
        cursesCoinsDisplay.textContent = formatNumber(caliCoins); // Use formatNumber
        geometrixDisplay.textContent = formatNumber(geometrix); // NEW GEOMETRIX
        rollMultipleBtn.textContent = `Roll ${rollBulk} Times`;
      }
      
      // ... (rest of the display/render functions remain unchanged) ...

      // --- GAME LOOP MODIFICATION ---
      function gameLoop() {
        // Cooldown and Yin-Yang timer logic remains here
        
        // ... (Existing Merchant, Cooldown, Yin-Yang logic) ...
        
        // --- NEW POLYGON GAME LOOP LOGIC ---
        if (shapesUnlocked) {
            // Decrease cooldown by one tick (GAME_TICK_RATE is 100ms)
            polygonCooldownRemaining -= (GAME_TICK_RATE / 1000); 
            
            if (polygonCooldownRemaining <= 0) {
                spawnPolygon(); // This calls saveAll() and renderShapes()
            } else {
                // If no spawn occurred, just update the display (without saving)
                polygonCooldownDisplay.textContent = Math.max(0, polygonCooldownRemaining).toFixed(3);
                
                // If Geometrix tab is open, ensure it's rendered for updates
                if (shapesSection.style.display === 'block') {
                    renderShapes();
                }
            }
        }
        
        saveAll(); // Save game state (excluding the temporary cooldown decrement)
        updateCoinsDisplay(); // Ensures Geometrix/Cali-coins are updated
        
        setTimeout(gameLoop, GAME_TICK_RATE); // Run every 100ms
      }

      // --- FIX: RE-ADDING MISSING EVENT LISTENERS FOR ROLLS ---
      
      // Assuming 1, 1, 1 are the default values for the arguments of your rollOnce function (e.g., number of rolls, luck factor, special luck factor)
      
      rollOnceBtn.addEventListener('click', () => {
        if (isCooldown) return;
        multiRolls = [];
        totalRolls++;
        
        // NOTE: Your original rollOnce function must be defined elsewhere in this script for this to work.
        const roll = rollOnce(1, 1, 1); 
        multiRolls.push(roll.inventoryData);
        
        let displayResult = roll.result.replace(/ROLLINDEX/g, '0').replace(/RANKBUTTON/g, roll.inventoryData ? 
          `<button class="rank-button" id="rank-btn-0" onclick="acceptRoll(0)">${roll.inventoryData.rank}</button>` : 
          roll.inventoryData ? roll.inventoryData.rank : '???');
        
        resultsDiv.innerHTML = displayResult;
        if (roll.cooldown > 0) setCooldown(roll.cooldown);
        saveAll();
      });

      rollMultipleBtn.addEventListener('click', () => {
        if (isCooldown) return;
        multiRolls = [];
        let output = '';
        let maxCooldown = 0;
        
        for (let i = 0; i < rollBulk; i++) {
          totalRolls++;
          // NOTE: Your original rollOnce function must be defined elsewhere in this script for this to work.
          const roll = rollOnce(1, 1, 1); 
          multiRolls.push(roll.inventoryData);
          
          let displayResult = roll.result.replace(/ROLLINDEX/g, i.toString()).replace(/RANKBUTTON/g, roll.inventoryData ? 
            `<button class="rank-button" id="rank-btn-${i}" onclick="acceptRoll(${i})">${roll.inventoryData.rank}</button>` : 
            '???');
          
          output += `<div class="roll-line">${displayResult}</div>`;
          if (roll.cooldown > maxCooldown) maxCooldown = roll.cooldown;
        }
        
        saveAll();
        resultsDiv.innerHTML = output;
        if (maxCooldown > 0) setCooldown(maxCooldown);
      });
      
      rollSpecialLuckBtn.addEventListener('click', () => {
        if (isCooldown) return;
        if (caliCoins < 1e35) {
          alert('Not enough coins! You need 1e35 Cali-coins.');
          return;
        }
        
        caliCoins -= 1e35;
        multiRolls = [];
        totalRolls++;
        saveAll();
        // NOTE: Your original rollOnce function must be defined elsewhere in this script for this to work.
        const roll = rollOnce(10, 10, 10000 * secretLuckBonus);
        multiRolls.push(roll.inventoryData);
        
        let displayResult = roll.result.replace(/ROLLINDEX/g, '0').replace(/RANKBUTTON/g, roll.inventoryData ? 
          `<button class="rank-button" id="rank-btn-0" onclick="acceptRoll(0)">${roll.inventoryData.rank}</button>` : 
          roll.inventoryData ? roll.inventoryData.rank : '???');
        
        resultsDiv.innerHTML = '<span style="color: gold;">SUPER LUCK ROLL!</span><br>' + displayResult;
        if (roll.cooldown > 0) setCooldown(roll.cooldown);
        saveAll();
      });
      
      // ... (rest of the original file's functions like pvpRoll, renderPVPUpgrades, etc.) ...
      
      function initGame() {
        loadInventory();
        loadShopData();
        loadCooldownSettings();
        loadDiscovered();
        generateMerchantStock();
        renderInventory();
        renderShop();
        renderMerchant();
        renderCurses();
        updatePVPDisplay();
        updateCoinsDisplay();
        
        // Initial render for the new section
        renderShapes();
      }

      initGame();
      gameLoop(); // Start the main game loop
      
    </script>
  </body>
</html>
