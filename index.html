<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>calis rng</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Balthazar:wght@400;700&display=swap');

      body {
        font-family: 'Balthazar', serif;
        margin: 0;
        padding: 0;
        background: #6a0dad;
        color: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
      }

      .game-container {
        background: #2c2c2c;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        min-width: 350px;
        max-width: 900px;
      }

      button {
        padding: 10px 20px;
        margin: 5px;
        font-size: 16px;
        cursor: pointer;
        background-color: #c71585;
        color: #fff;
        border: none;
        border-radius: 5px;
        transition: background-color 0.3s;
        font-family: 'Balthazar', serif;
        font-weight: 700;
      }

      button:disabled {
        background-color: #555;
        cursor: not-allowed;
      }

      button:hover:not(:disabled) {
        background-color: #e754bb;
      }

      #results {
        margin-top: 20px;
        white-space: pre-line;
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 5px;
        min-height: 100px;
        font-family: 'Balthazar', serif;
      }

      .bold {
        font-weight: 700;
      }

      .roll-line {
        margin: 5px 0;
      }

      .rank-button {
        background: none;
        border: 2px solid #28a745;
        color: inherit;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 3px;
        font-family: 'Balthazar', serif;
        transition: all 0.2s;
        display: inline;
      }

      .rank-button:hover {
        background-color: rgba(40, 167, 69, 0.2);
        border-color: #34d058;
      }

      .rank-button.accepted {
        opacity: 0.3;
        cursor: default;
        border-color: #555;
      }

      .rank-button.accepted:hover {
        background: none;
        border-color: #555;
      }

      .inventory-section {
        margin-top: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      }

      .inventory-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 5px;
        margin-top: 15px;
      }

      .inventory-slot {
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid #555;
        border-radius: 5px;
        padding: 5px;
        min-height: 40px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .inventory-slot:hover {
        background: rgba(0, 0, 0, 0.5);
        border-color: #888;
      }

      .inventory-slot.empty {
        cursor: default;
        opacity: 0.5;
      }

      .inventory-slot.empty:hover {
        background: rgba(0, 0, 0, 0.3);
        border-color: #555;
      }

      .slot-variants {
        font-size: 8px;
        margin-bottom: 2px;
        color: #ffd700;
      }

      .slot-value {
        font-weight: 700;
        margin-bottom: 2px;
        font-size: 9px;
      }

      .slot-rank {
        font-size: 9px;
        opacity: 0.8;
      }

      .index-section {
        margin-top: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        max-height: 500px;
        overflow-y: auto;
      }

      .index-category {
        margin-bottom: 20px;
        text-align: left;
      }

      .index-category h3 {
        margin-bottom: 10px;
        color: #c71585;
      }

      .index-item {
        padding: 5px;
        margin: 3px 0;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
      }

      .index-item.discovered {
        color: #4ade80;
      }

      .index-item.undiscovered {
        color: #666;
      }

      #toggleIndex {
        margin-top: 10px;
        background-color: #6a0dad;
      }

      #toggleIndex:hover {
        background-color: #8a2dcd;
      }

      #toggleShop {
        margin-top: 10px;
        background-color: #d4af37;
        color: #000;
      }

      #toggleShop:hover {
        background-color: #f0c748;
      }

      #toggleSellMode {
        background-color: #ff6b35;
      }

      #toggleSellMode:hover {
        background-color: #ff8555;
      }

      #toggleSellMode.active {
        background-color: #ff3333;
      }

      .shop-section {
        margin-top: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      }

      .coins-display {
        font-size: 24px;
        font-weight: 700;
        color: #d4af37;
        margin-bottom: 20px;
      }

      .shop-item {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        border: 2px solid #555;
      }

      .shop-item h4 {
        margin: 0 0 10px 0;
        color: #fff;
      }

      .shop-item p {
        margin: 5px 0;
        font-size: 14px;
      }

      .shop-item button {
        margin-top: 10px;
        background-color: #d4af37;
        color: #000;
      }

      .shop-item button:hover:not(:disabled) {
        background-color: #f0c748;
      }

      .shop-item button:disabled {
        background-color: #555;
        color: #888;
      }

      .maxed {
        color: #4ade80;
        font-weight: 700;
      }

      .roll-counter {
        margin-bottom: 15px;
        font-size: 18px;
        color: #d4af37;
      }

      #toggleMerchant {
        background-color: #4ade80;
        color: #000;
      }

      #toggleMerchant:hover {
        background-color: #5ef090;
      }

      #toggleItemInventory {
        background-color: #a855f7;
      }

      #toggleItemInventory:hover {
        background-color: #b865ff;
      }

      .merchant-section {
        margin-top: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      }

      .merchant-timer {
        font-size: 16px;
        color: #4ade80;
        margin-bottom: 15px;
      }

      .merchant-items {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        max-height: 400px;
        overflow-y: auto;
      }

      .merchant-item {
        background: rgba(0, 0, 0, 0.4);
        padding: 15px;
        border-radius: 5px;
        border: 2px solid #4ade80;
      }

      .merchant-item h4 {
        margin: 0 0 10px 0;
        color: #4ade80;
      }

      .item-inventory-section {
        margin-top: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      }

      .item-slot {
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid #a855f7;
        border-radius: 5px;
        padding: 10px;
        min-height: 50px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
      }

      .item-slot:hover {
        background: rgba(0, 0, 0, 0.5);
        border-color: #b865ff;
      }

      .item-slot.empty {
        cursor: default;
        opacity: 0.5;
      }

      .item-slot.empty:hover {
        background: rgba(0, 0, 0, 0.3);
        border-color: #a855f7;
      }

      .item-name {
        font-weight: 700;
        font-size: 12px;
        margin-bottom: 5px;
      }

      .item-multiplier {
        font-size: 10px;
        color: #ffd700;
      }

      #togglePVP {
        background-color: #ef4444;
      }

      #togglePVP:hover {
        background-color: #ff5555;
      }

      #toggleCurses {
        background-color: #7c3aed;
      }

      #toggleCurses:hover {
        background-color: #8b5cf6;
      }

      .pvp-section {
        margin-top: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      }

      .pvp-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 20px;
      }

      .pvp-stat {
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 5px;
        border: 2px solid #ef4444;
      }

      .pvp-stat h4 {
        margin: 0 0 5px 0;
        color: #ef4444;
      }

      .pvp-results {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px;
        border-radius: 5px;
        margin-top: 15px;
        min-height: 100px;
      }

      .pvp-upgrades {
        margin-top: 20px;
      }

      .curses-section {
        margin-top: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      }

      .curse-item {
        background: rgba(0, 0, 0, 0.4);
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        border: 2px solid #7c3aed;
      }

      .curse-item.active {
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.2);
      }

      .curse-item h4 {
        margin: 0 0 10px 0;
        color: #7c3aed;
      }

      .curse-item.active h4 {
        color: #ef4444;
      }

      #rollSpecialLuck {
        background-color: #f59e0b;
      }

      #rollSpecialLuck:hover:not(:disabled) {
        background-color: #fbbf24;
      }

      .music-control {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px;
        border-radius: 10px;
        border: 2px solid #c71585;
      }

      .music-control button {
        padding: 5px 10px;
        font-size: 12px;
        margin: 2px;
      }

      .music-status {
        font-size: 10px;
        margin-bottom: 5px;
        color: #4ade80;
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <h1>calis rng game</h1>
      <p style="color: #fbbf24; font-size: 12px; margin: 10px 0;">i suggest you don't spam roll if you just started! only do it when you have the 'Calis Blessing' upgrade - cali</p>
      <div class="roll-counter">
        Total Rolls: <span id="rollCounter">0</span>
      </div>
      <button id="rollOnceBtn">Roll Once</button>
      <button id="rollMultipleBtn">Roll 15 Times</button>
      <button id="rollSpecialLuck">Roll Once (x10000 Special Luck)</button>
      <button id="toggleInventory">Toggle Inventory</button>
      <button id="toggleIndex">Toggle Index</button>
      <button id="toggleShop">Toggle Shop</button>
      <button id="toggleMerchant">Toggle Merchant</button>
      <button id="toggleItemInventory">Toggle Item Inventory</button>
      <button id="togglePVP">Toggle PVP</button>
      <button id="toggleCurses">Toggle Curses</button>
      <button id="toggleSellMode">Sell Mode: OFF</button>

      <div id="results"></div>

      <div class="inventory-section" id="inventorySection" style="display: none;">
        <h2>Inventory (<span id="inventoryCount">0</span>/<span id="maxSlotsDisplay">250</span> slots)</h2>
        <div class="inventory-grid" id="inventoryGrid"></div>
      </div>

      <div class="shop-section" id="shopSection" style="display: none;">
        <h2>Shop</h2>
        <div class="coins-display">Cali-coins: <span id="coinsDisplay">0</span></div>
        <div id="shopContent"></div>
      </div>

      <div class="merchant-section" id="merchantSection" style="display: none;">
        <h2>Merchant</h2>
        <div class="coins-display">Cali-coins: <span id="merchantCoinsDisplay">0</span></div>
        <div class="merchant-timer">Next restock in: <span id="merchantTimer">30</span>s</div>
        <div class="merchant-items" id="merchantItems"></div>
      </div>

      <div class="item-inventory-section" id="itemInventorySection" style="display: none;">
        <h2>Item Inventory (<span id="itemInventoryCount">0</span>/50 slots)</h2>
        <div class="inventory-grid" id="itemInventoryGrid"></div>
      </div>

      <div class="pvp-section" id="pvpSection" style="display: none;">
        <h2>PVP Arena</h2>
        <div class="pvp-stats">
          <div class="pvp-stat">
            <h4>PVP Coins</h4>
            <p id="pvpCoinsDisplay">0</p>
          </div>
          <div class="pvp-stat">
            <h4>Win Streak</h4>
            <p id="winStreakDisplay">0</p>
          </div>
          <div class="pvp-stat">
            <h4>Total Wins</h4>
            <p id="totalWinsDisplay">0</p>
          </div>
        </div>
        <button id="pvpRollBtn">Roll Against Opponent</button>
        <div class="pvp-results" id="pvpResults"></div>
        <div class="pvp-upgrades">
          <h3>PVP Upgrades</h3>
          <div id="pvpUpgradesContent"></div>
        </div>
      </div>

      <div class="curses-section" id="cursesSection" style="display: none;">
        <h2>Curses</h2>
        <div class="coins-display">Cali-coins: <span id="cursesCoinsDisplay">0</span></div>
        <p style="color: #fbbf24; margin-bottom: 15px;">Only ONE curse can be active at a time. Costs 16.66% of current coins to unequip.</p>
        <div id="cursesContent"></div>
      </div>

      <div class="index-section" id="indexSection" style="display: none;">
        <h2>Discovery Index</h2>
        <div id="indexContent"></div>
      </div>
    </div>

    <div class="music-control">
      <div class="music-status" id="musicStatus">Music: Not Started</div>
      <button id="startMusic">Start Music</button>
      <button id="toggleMusic" style="display: none;">Pause</button>
      <button id="skipMusic" style="display: none;">Skip</button>
    </div>

    <script>
      const resultsDiv = document.getElementById('results');
      const rollOnceBtn = document.getElementById('rollOnceBtn');
      const rollMultipleBtn = document.getElementById('rollMultipleBtn');
      const rollSpecialLuckBtn = document.getElementById('rollSpecialLuck');
      const toggleInventoryBtn = document.getElementById('toggleInventory');
      const toggleIndexBtn = document.getElementById('toggleIndex');
      const toggleShopBtn = document.getElementById('toggleShop');
      const toggleMerchantBtn = document.getElementById('toggleMerchant');
      const toggleItemInventoryBtn = document.getElementById('toggleItemInventory');
      const togglePVPBtn = document.getElementById('togglePVP');
      const toggleCursesBtn = document.getElementById('toggleCurses');
      const toggleSellModeBtn = document.getElementById('toggleSellMode');
      const inventorySection = document.getElementById('inventorySection');
      const indexSection = document.getElementById('indexSection');
      const shopSection = document.getElementById('shopSection');
      const merchantSection = document.getElementById('merchantSection');
      const itemInventorySection = document.getElementById('itemInventorySection');
      const pvpSection = document.getElementById('pvpSection');
      const cursesSection = document.getElementById('cursesSection');
      const pvpRollBtn = document.getElementById('pvpRollBtn');
      const indexContent = document.getElementById('indexContent');
      const shopContent = document.getElementById('shopContent');
      const merchantItems = document.getElementById('merchantItems');
      const itemInventoryGrid = document.getElementById('itemInventoryGrid');
      const pvpResults = document.getElementById('pvpResults');
      const pvpUpgradesContent = document.getElementById('pvpUpgradesContent');
      const cursesContent = document.getElementById('cursesContent');
      const coinsDisplay = document.getElementById('coinsDisplay');
      const merchantCoinsDisplay = document.getElementById('merchantCoinsDisplay');
      const cursesCoinsDisplay = document.getElementById('cursesCoinsDisplay');
      const inventoryCountDisplay = document.getElementById('inventoryCount');
      const itemInventoryCountDisplay = document.getElementById('itemInventoryCount');
      const maxSlotsDisplay = document.getElementById('maxSlotsDisplay');
      const inventoryGrid = document.getElementById('inventoryGrid');
      const rollCounterDisplay = document.getElementById('rollCounter');
      const merchantTimer = document.getElementById('merchantTimer');
      const pvpCoinsDisplay = document.getElementById('pvpCoinsDisplay');
      const winStreakDisplay = document.getElementById('winStreakDisplay');
      const totalWinsDisplay = document.getElementById('totalWinsDisplay');
      const startMusicBtn = document.getElementById('startMusic');
      const toggleMusicBtn = document.getElementById('toggleMusic');
      const skipMusicBtn = document.getElementById('skipMusic');
      const musicStatus = document.getElementById('musicStatus');
      
      let isCooldown = false;
      let isPVPCooldown = false;
      let multiRolls = [];
      let inventory = [];
      let itemInventory = [];
      let discovered = { ranks: [], specialRanks: [], secretRanks: [], variantSecrets: [], variants: [] };
      let caliCoins = 0;
      let maxSlots = 250;
      let sellExponent = 0.33;
      let rollBulk = 15;
      let variantLuckBonus = 1;
      let availabilityUnlocked = false;
      let totalRolls = 0;
      let calisBlessingActive = false;
      let blessingBoosterActive = false;
      let secretLuckBonus = 1;
      let specialLuckBonus = 1;
      let generalLuckBonus = 1;
      let merchantTimeLeft = 30;
      let merchantStock = [];
      let pvpCoins = 0;
      let winStreak = 0;
      let totalWins = 0;
      let rngExponent = 1;
      let activeCurse = null;
      let cursesUnlocked = false;
      let yinYangState = 'normal';
      let yinYangTimer = 60;
      let playedSongs = [];
      let currentAudio = null;
      let musicPaused = false;
      let musicStarted = false;
      
      let shopUpgrades = {
        variantLuck: 0,
        rollBulk: 0,
        secretLuck: 0,
        specialLuck: 0,
        generalLuck: 0,
        sellPower: 0,
        availability: false,
        calisBlessing: false,
        blessingBooster: false
      };
      
      let pvpUpgrades = {
        bulkRoll: 0,
        rngExponent: 0
      };
      
      const CURSES = {
        greed: {
          name: 'Greed',
          description: 'x5 PVP coins and Cali-coins gain, but divide all luck by 10',
          pvpCost: 250
        },
        cursedMultiplier: {
          name: 'Cursed Multiplier',
          description: 'Every booster is x5 better, but 1/2.5 chance to ruin roll (gives 1.01 with no variants)',
          pvpCost: 250
        }
      };
      
      let lastClickTime = {};
      let sellMode = false;

      const ALL_RANKS = ['nothing', 'Common', 'Natural', 'Rare', 'Unnatural', 'Epic', 'Decent', 'Mythical', 'Legendary', 'Unreal', 'Super Rare', 'Eternal', 'Starstruck', 'Paradoxical', 'Iridescent', 'Lux', 'Possible', 'RNGesus', 'CRAZY', 'Supreme', 'DAMN', 'Stupiditium', 'ASCENDED', 'Obscure', 'INFINITE', 'Divine', 'Insurmountable', 'GRAND', 'what.', 'FINALE', 'Microb', 'Attainable', 'Directional', 'Limitless', 'Endless'];
      
      const ALL_SPECIAL_RANKS = ['In im table ?!?!?', '???UNKNOWN???', 'leaflet', 'nil', 'NOTHINGNESS', 'INSANE', 'Lmao', 'PERFECTIONIST', 'Imaginary', 'NICE', 'FUNNY', 'Common : DIVINITY', 'Legacy FINALE', 'Catastrophic', '<(ETERNAL DAWN)>', 'UNOBTAINABLE', 'Everlasting', 'RNGod', 'Invisible', 'cali', 'RNGarbage', 'Cheesium', 'pepeCringe', 'EZ', 'The Great Special Rank With An Unnecessary Long Name, Anyways Are You Even Reading This? I Bet Not. If You Are Good Job Cuz You Wasted Time On This, Why? Anyways, Be Happy You Rolled This. Its The Rarest Special Rank. Haha I Am Making You Read This Weird Rank Name Anyways So What? Its Just A RNG Game Rank Anyways  Just Stop. You Did Too Much Reading For A Simple RNG Game Bro I Am Telling You Stop Its Just A Rank Of All Things', '100'];
      
      const ALL_SECRET_RANKS = ['ðŸŸ', 'Destiny', 'ðŸŒ³', 'ULTIMATE'];
      
      const ALL_VARIANT_SECRETS = ['(Existance)', 'COLOSSAL'];
      
      const ALL_VARIANTS = ['shiny', 'golden', 'inverse', 'retro', 'bright', 'cosmic', 'GIGANTIC', 'h o r s e', 'eternal', 'dark', 'UNIVERSAL', 'Modified', 'Colorful', 'Gigaconfuscibretrationiminousis', 'Possible', 'Gargantuan', 'Ethereal', 'Limitless', 'INFINITUM', 'evil', 'Light', 'void.', 'Unhonored', 'REALITY'];

      function initMusic() {
      }

      function playNextSong() {
        if (musicPaused || !musicStarted) return;
        
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const notes = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25];
          let currentNote = 0;
          let noteInterval;
          
          function playNote() {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = notes[currentNote];
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
            
            currentNote = (currentNote + Math.floor(Math.random() * 3) + 1) % notes.length;
          }
          
          noteInterval = setInterval(playNote, 500);
          musicStatus.textContent = 'Music: Playing';
          
          window.musicCleanup = () => {
            clearInterval(noteInterval);
            audioContext.close();
          };
        } catch (e) {
          console.log('Music generation failed:', e);
          musicStatus.textContent = 'Music: Error';
        }
      }

      startMusicBtn.addEventListener('click', () => {
        musicStarted = true;
        startMusicBtn.style.display = 'none';
        toggleMusicBtn.style.display = 'inline-block';
        skipMusicBtn.style.display = 'inline-block';
        playNextSong();
      });

      toggleMusicBtn.addEventListener('click', () => {
        if (musicPaused) {
          musicPaused = false;
          toggleMusicBtn.textContent = 'Pause';
          playNextSong();
        } else {
          musicPaused = true;
          toggleMusicBtn.textContent = 'Play';
          if (window.musicCleanup) window.musicCleanup();
          musicStatus.textContent = 'Music: Paused';
        }
      });

      skipMusicBtn.addEventListener('click', () => {
        if (window.musicCleanup) window.musicCleanup();
        playNextSong();
      });

      function generateMerchantStock() {
        merchantStock = [];
        
        for (let i = 0; i < 12; i++) {
          const rand = Math.random();
          
          if (rand < 1/10) {
            merchantStock.push({
              name: 'Cheese',
              cost: 69,
              description: '1/5.55 chance to force a special roll',
              type: 'cheese'
            });
          } else if (rand < 1/10 + 1/60) {
            merchantStock.push({
              name: 'EVIL Booster',
              cost: 6,
              description: 'SO EVIL!!!',
              type: 'evilBooster'
            });
          } else if (rand < 1/10 + 1/60 + 1/100) {
            const multiplier = Math.pow(Math.random(), -2.5);
            const cost = Math.floor(Math.pow(multiplier, 1.25));
            merchantStock.push({
              name: 'Special Booster',
              cost: cost,
              description: `Multiplies special luck by ${multiplier.toFixed(2)}x`,
              multiplier: multiplier,
              type: 'specialBooster'
            });
          } else if (rand < 1/10 + 1/60 + 1/100 + 1/10) {
            const multiplier = Math.pow(Math.random(), -2.5);
            const cost = Math.floor(Math.pow(multiplier, 1.25));
            merchantStock.push({
              name: 'Variant Booster',
              cost: cost,
              description: `Multiplies variant luck by ${multiplier.toFixed(2)}x`,
              multiplier: multiplier,
              type: 'variantBooster'
            });
          } else if (rand < 1/10 + 1/60 + 1/100 + 1/10 + 1/200) {
            merchantStock.push({
              name: 'Yin-Yang',
              cost: 500,
              description: 'Every minute, switches between x100 normal luck/x0 special and x0 normal/x100,000 special',
              type: 'yinYang'
            });
          } else {
            const multiplier = Math.pow(Math.random(), -2.5);
            const cost = Math.floor(Math.pow(multiplier, 1.25));
            merchantStock.push({
              name: 'Booster',
              cost: cost,
              description: `Multiplies luck by ${multiplier.toFixed(2)}x`,
              multiplier: multiplier,
              type: 'booster'
            });
          }
        }
      }

      function renderMerchant() {
        merchantCoinsDisplay.textContent = caliCoins.toFixed(2);
        merchantItems.innerHTML = '';
        
        if (merchantStock.length === 0) {
          merchantItems.innerHTML = '<p style="grid-column: 1 / -1;">No items in stock</p>';
          return;
        }
        
        merchantStock.forEach((item, index) => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'merchant-item';
          itemDiv.innerHTML = `
            <h4>${item.name}</h4>
            <p>${item.description}</p>
            <p>Cost: ${item.cost} coins</p>
            <button onclick="buyMerchantItem(${index})" ${caliCoins < item.cost || itemInventory.length >= 50 ? 'disabled' : ''}>Buy</button>
          `;
          merchantItems.appendChild(itemDiv);
        });
      }

      window.buyMerchantItem = function(index) {
        const item = merchantStock[index];
        if (!item || caliCoins < item.cost || itemInventory.length >= 50) return;
        
        caliCoins -= item.cost;
        itemInventory.push(item);
        merchantStock.splice(index, 1);
        
        saveAll();
        renderMerchant();
        renderItemInventory();
      };

      function renderItemInventory() {
        itemInventoryGrid.innerHTML = '';
        itemInventoryCountDisplay.textContent = itemInventory.length;
        
        for (let i = 0; i < 50; i++) {
          const slot = document.createElement('div');
          
          if (itemInventory[i]) {
            const item = itemInventory[i];
            slot.className = 'item-slot';
            
            const nameDiv = document.createElement('div');
            nameDiv.className = 'item-name';
            nameDiv.textContent = item.name;
            slot.appendChild(nameDiv);
            
            if (item.multiplier) {
              const multDiv = document.createElement('div');
              multDiv.className = 'item-multiplier';
              multDiv.textContent = `${item.multiplier.toFixed(2)}x`;
              slot.appendChild(multDiv);
            }
            
            slot.onclick = () => useItem(i);
          } else {
            slot.className = 'item-slot empty';
            slot.textContent = 'Empty';
          }
          
          itemInventoryGrid.appendChild(slot);
        }
      }

      function useItem(index) {
        const item = itemInventory[index];
        if (!item) return;
        
        if (item.type === 'cheese') {
          if (Math.random() < 1/5.55) {
            totalRolls++;
            const roll = rollOnce(1, 1, 1, true);
            multiRolls = [roll.inventoryData];
            
            let displayResult = roll.result.replace(/ROLLINDEX/g, '0').replace(/RANKBUTTON/g, 
              `<button class="rank-button" id="rank-btn-0" onclick="acceptRoll(0)">${roll.inventoryData.rank}</button>`);
            
            resultsDiv.innerHTML = displayResult;
            if (roll.cooldown > 0) setCooldown(roll.cooldown);
          } else {
            resultsDiv.innerHTML = '<span style="color: yellow;">The cheese did nothing...</span>';
          }
        } else if (item.type === 'evilBooster') {
          totalRolls++;
          const invData = {
            variants: '',
            displayValue: '1.00',
            rank: 'nothing',
            color: 'white'
          };
          multiRolls = [invData];
          resultsDiv.innerHTML = '<span style="color: #ef4444; font-weight: 700;">SO EVIL!!!</span><br><span>You rolled a/an 1.00 <button class="rank-button" id="rank-btn-0" onclick="acceptRoll(0)">nothing</button>!</span>';
        } else if (item.type === 'booster') {
          let boostMultiplier = item.multiplier;
          if (activeCurse === 'cursedMultiplier') {
            boostMultiplier *= 5;
            if (Math.random() < 1/2.5) {
              const invData = {
                variants: '',
                displayValue: '1.01',
                rank: 'Common',
                color: 'white'
              };
              multiRolls = [invData];
              resultsDiv.innerHTML = '<span style="color: #ef4444;">CURSED! Roll ruined!</span><br><span>You rolled a/an 1.01 <button class="rank-button" id="rank-btn-0" onclick="acceptRoll(0)">Common</button>!</span>';
              itemInventory.splice(index, 1);
              saveAll();
              renderItemInventory();
              return;
            }
          }
          
          totalRolls++;
          const roll = rollOnce(boostMultiplier, boostMultiplier, boostMultiplier);
          multiRolls = [roll.inventoryData];
          
          let displayResult = roll.result.replace(/ROLLINDEX/g, '0').replace(/RANKBUTTON/g, 
            `<button class="rank-button" id="rank-btn-0" onclick="acceptRoll(0)">${roll.inventoryData.rank}</button>`);
          
          const curseText = activeCurse === 'cursedMultiplier' ? ' (CURSED x5)' : '';
          resultsDiv.innerHTML = '<span style="color: gold;">BOOSTER ACTIVATED! (Luck x' + boostMultiplier.toFixed(2) + curseText + ')</span><br>' + displayResult;
          if (roll.cooldown > 0) setCooldown(roll.cooldown);
        } else if (item.type === 'specialBooster') {
          totalRolls++;
          const roll = rollOnce(1, 1, 1);
          specialLuckBonus *= item.multiplier;
          multiRolls = [roll.inventoryData];
          
          let displayResult = roll.result.replace(/ROLLINDEX/g, '0').replace(/RANKBUTTON/g, 
            `<button class="rank-button" id="rank-btn-0" onclick="acceptRoll(0)">${roll.inventoryData.rank}</button>`);
          
          resultsDiv.innerHTML = '<span style="color: #ff1493;">SPECIAL BOOSTER ACTIVATED! (Special Luck x' + item.multiplier.toFixed(2) + ')</span><br>' + displayResult;
          
          specialLuckBonus = 1 + ((shopUpgrades.specialLuck || 0) * 0.1);
          
          if (roll.cooldown > 0) setCooldown(roll.cooldown);
        } else if (item.type === 'variantBooster') {
          totalRolls++;
          const roll = rollOnce(1, item.multiplier, 1);
          multiRolls = [roll.inventoryData];
          
          let displayResult = roll.result.replace(/ROLLINDEX/g, '0').replace(/RANKBUTTON/g, 
            `<button class="rank-button" id="rank-btn-0" onclick="acceptRoll(0)">${roll.inventoryData.rank}</button>`);
          
          resultsDiv.innerHTML = '<span style="color: #a855f7;">VARIANT BOOSTER ACTIVATED! (Variant Luck x' + item.multiplier.toFixed(2) + ')</span><br>' + displayResult;
          if (roll.cooldown > 0) setCooldown(roll.cooldown);
        } else if (item.type === 'yinYang') {
          resultsDiv.innerHTML = '<span style="color: #fbbf24;">Yin-Yang activated! Effect lasts for the item\'s duration in inventory.</span>';
          saveAll();
          renderItemInventory();
          return;
        }
        
        itemInventory.splice(index, 1);
        saveAll();
        renderItemInventory();
      }

      setInterval(() => {
        merchantTimeLeft--;
        merchantTimer.textContent = merchantTimeLeft;
        
        if (merchantTimeLeft <= 0) {
          merchantTimeLeft = 30;
          generateMerchantStock();
          renderMerchant();
        }
        
        const hasYinYang = itemInventory.some(item => item.type === 'yinYang');
        if (hasYinYang) {
          yinYangTimer--;
          if (yinYangTimer <= 0) {
            yinYangTimer = 60;
            yinYangState = yinYangState === 'normal' ? 'special' : 'normal';
          }
        }
      }, 1000);

      function renderPVPUpgrades() {
        let html = '';
        
        const bulkCost = Math.floor(10 * Math.pow(1.5, pvpUpgrades.bulkRoll));
        const bulkMaxed = pvpUpgrades.bulkRoll >= 5;
        html += `<div class="shop-item">
          <h4>+10 Bulk Roll</h4>
          <p>Current: Roll ${rollBulk} Times</p>
          <p>Cost: ${bulkCost} PVP Coins</p>
          <p>Upgrades: ${pvpUpgrades.bulkRoll}/5</p>
          ${bulkMaxed ? '<p class="maxed">MAXED</p>' : `<button onclick="buyPVPUpgrade('bulkRoll')" ${pvpCoins < bulkCost || bulkMaxed ? 'disabled' : ''}>Buy</button>`}
        </div>`;
        
        const expCost = Math.floor(5 * Math.pow(2, pvpUpgrades.rngExponent));
        const expMaxed = pvpUpgrades.rngExponent >= 5;
        html += `<div class="shop-item">
          <h4>+0.1 RNG Exponent</h4>
          <p>Current: ^${rngExponent.toFixed(1)}</p>
          <p>Cost: ${expCost} PVP Coins</p>
          <p>Upgrades: ${pvpUpgrades.rngExponent}/5</p>
          ${expMaxed ? '<p class="maxed">MAXED</p>' : `<button onclick="buyPVPUpgrade('rngExponent')" ${pvpCoins < expCost || expMaxed ? 'disabled' : ''}>Buy</button>`}
        </div>`;
        
        pvpUpgradesContent.innerHTML = html;
      }

      window.buyPVPUpgrade = function(type) {
        if (type === 'bulkRoll') {
          const cost = Math.floor(10 * Math.pow(1.5, pvpUpgrades.bulkRoll));
          if (pvpCoins >= cost && pvpUpgrades.bulkRoll < 5) {
            pvpCoins -= cost;
            pvpUpgrades.bulkRoll++;
            rollBulk += 10;
            saveAll();
            renderPVPUpgrades();
            updatePVPDisplay();
          }
        } else if (type === 'rngExponent') {
          const cost = Math.floor(5 * Math.pow(2, pvpUpgrades.rngExponent));
          if (pvpCoins >= cost && pvpUpgrades.rngExponent < 5) {
            pvpCoins -= cost;
            pvpUpgrades.rngExponent++;
            rngExponent += 0.1;
            saveAll();
            renderPVPUpgrades();
            updatePVPDisplay();
          }
        }
      };

      function updatePVPDisplay() {
        pvpCoinsDisplay.textContent = pvpCoins;
        winStreakDisplay.textContent = winStreak;
        totalWinsDisplay.textContent = totalWins;
      }

      function renderCurses() {
        cursesCoinsDisplay.textContent = caliCoins.toFixed(2);
        let html = '';
        
        Object.keys(CURSES).forEach(curseKey => {
          const curse = CURSES[curseKey];
          const isActive = activeCurse === curseKey;
          const className = isActive ? 'curse-item active' : 'curse-item';
          const unequipCost = (caliCoins * 0.1666).toFixed(2);
          const equipCost = (caliCoins * 0.25).toFixed(2);
          
          html += `<div class="${className}">
            <h4>${curse.name}</h4>
            <p>${curse.description}</p>
            ${isActive ? 
              `<p style="color: #ef4444;">ACTIVE</p>
               <button onclick="unequipCurse()" ${caliCoins < caliCoins * 0.1666 ? 'disabled' : ''}>Unequip (${unequipCost} coins)</button>` :
              `<button onclick="equipCurse('${curseKey}')" ${activeCurse || caliCoins < caliCoins * 0.25 ? 'disabled' : ''}>Equip (${equipCost} coins)</button>`
            }
          </div>`;
        });
        
        cursesContent.innerHTML = html;
      }

      window.equipCurse = function(curseKey) {
        if (activeCurse) {
          alert('You already have a curse equipped! Unequip it first.');
          return;
        }
        
        const cost = caliCoins * 0.25;
        if (caliCoins < cost) return;
        
        caliCoins -= cost;
        activeCurse = curseKey;
        saveAll();
        renderCurses();
      };

      window.unequipCurse = function() {
        const cost = caliCoins * 0.1666;
        if (caliCoins < cost) return;
        
        caliCoins -= cost;
        activeCurse = null;
        saveAll();
        renderCurses();
      };

      pvpRollBtn.addEventListener('click', () => {
        if (isPVPCooldown) return;
        
        const playerRoll = rollOnce(1, 1, 1);
        const opponentRoll = rollOnce(1, 1, 1);
        
        let playerValue = parseFloat(playerRoll.inventoryData.displayValue.replace(/,/g, ''));
        let opponentValue = parseFloat(opponentRoll.inventoryData.displayValue.replace(/,/g, ''));
        
        playerValue = Math.pow(Math.abs(playerValue), rngExponent);
        opponentValue = Math.pow(Math.abs(opponentValue), rngExponent);
        
        let result = '';
        if (playerValue > opponentValue) {
          winStreak++;
          totalWins++;
          const coinsGained = 1 + (winStreak > 1 ? (winStreak - 1) * 2 : 0);
          const finalCoins = activeCurse === 'greed' ? coinsGained * 5 : coinsGained;
          pvpCoins += finalCoins;
          result = `<span style="color: #4ade80; font-weight: 700;">YOU WIN!</span><br>
            You rolled: ${playerRoll.inventoryData.displayValue} (${playerRoll.inventoryData.rank})<br>
            Opponent rolled: ${opponentRoll.inventoryData.displayValue} (${opponentRoll.inventoryData.rank})<br>
            +${finalCoins} PVP Coins${activeCurse === 'greed' ? ' (GREED x5)' : ''} | Win Streak: ${winStreak}`;
        } else {
          winStreak = 0;
          result = `<span style="color: #ef4444; font-weight: 700;">YOU LOSE!</span><br>
            You rolled: ${playerRoll.inventoryData.displayValue} (${playerRoll.inventoryData.rank})<br>
            Opponent rolled: ${opponentRoll.inventoryData.displayValue} (${opponentRoll.inventoryData.rank})<br>
            Win streak reset!`;
        }
        
        pvpResults.innerHTML = result;
        updatePVPDisplay();
        saveAll();
        
        isPVPCooldown = true;
        pvpRollBtn.disabled = true;
        let remaining = 5;
        const interval = setInterval(() => {
          pvpRollBtn.textContent = `Cooldown: ${remaining}s`;
          remaining--;
          if (remaining < 0) {
            clearInterval(interval);
            pvpRollBtn.disabled = false;
            pvpRollBtn.textContent = 'Roll Against Opponent';
            isPVPCooldown = false;
          }
        }, 1000);
      });

      function loadDiscovered() {
        const saved = localStorage.getItem('calisRngDiscovered');
        if (saved) {
          try {
            discovered = JSON.parse(saved);
            if (!discovered.secretRanks) discovered.secretRanks = [];
            if (!discovered.variantSecrets) discovered.variantSecrets = [];
          } catch (e) {
            discovered = { ranks: [], specialRanks: [], secretRanks: [], variantSecrets: [], variants: [] };
          }
        }
      }

      function saveDiscovered() {
        localStorage.setItem('calisRngDiscovered', JSON.stringify(discovered));
      }

      function markDiscovered(type, name) {
        if (!discovered[type].includes(name)) {
          discovered[type].push(name);
          saveDiscovered();
        }
      }

      function renderIndex() {
        let html = '<div class="index-category"><h3>Variants</h3>';
        ALL_VARIANTS.forEach(v => {
          const isDiscovered = discovered.variants.includes(v);
          const icon = isDiscovered ? 'âœ“' : 'âœ—';
          const className = isDiscovered ? 'discovered' : 'undiscovered';
          html += `<div class="index-item ${className}">${icon} ${v}</div>`;
        });
        html += '</div>';

        html += '<div class="index-category"><h3>Variant Secrets</h3>';
        ALL_VARIANT_SECRETS.forEach(r => {
          const isDiscovered = discovered.variantSecrets.includes(r);
          const icon = isDiscovered ? 'âœ“' : 'âœ—';
          const className = isDiscovered ? 'discovered' : 'undiscovered';
          html += `<div class="index-item ${className}">${icon} ${r}</div>`;
        });
        html += '</div>';

        html += '<div class="index-category"><h3>Special Ranks</h3>';
        ALL_SPECIAL_RANKS.forEach(r => {
          if (r === 'cali' && !availabilityUnlocked) {
            html += `<div class="index-item undiscovered">âœ— ???</div>`;
          } else {
            const isDiscovered = discovered.specialRanks.includes(r);
            const icon = isDiscovered ? 'âœ“' : 'âœ—';
            const className = isDiscovered ? 'discovered' : 'undiscovered';
            html += `<div class="index-item ${className}">${icon} ${r}</div>`;
          }
        });
        html += '</div>';

        html += '<div class="index-category"><h3>Secret Ranks</h3>';
        ALL_SECRET_RANKS.forEach(r => {
          const isDiscovered = discovered.secretRanks.includes(r);
          const icon = isDiscovered ? 'âœ“' : 'âœ—';
          const className = isDiscovered ? 'discovered' : 'undiscovered';
          html += `<div class="index-item ${className}">${icon} ${r}</div>`;
        });
        html += '</div>';

        html += '<div class="index-category"><h3>Ranks</h3>';
        ALL_RANKS.forEach(r => {
          const isDiscovered = discovered.ranks.includes(r);
          const icon = isDiscovered ? 'âœ“' : 'âœ—';
          const className = isDiscovered ? 'discovered' : 'undiscovered';
          html += `<div class="index-item ${className}">${icon} ${r}</div>`;
        });
        html += '</div>';

        indexContent.innerHTML = html;
      }

      toggleInventoryBtn.addEventListener('click', () => {
        const sections = [inventorySection, indexSection, shopSection, merchantSection, itemInventorySection, pvpSection, cursesSection];
        if (inventorySection.style.display === 'none') {
          sections.forEach(s => s.style.display = 'none');
          inventorySection.style.display = 'block';
          renderInventory();
        } else {
          inventorySection.style.display = 'none';
        }
      });

      toggleIndexBtn.addEventListener('click', () => {
        const sections = [inventorySection, indexSection, shopSection, merchantSection, itemInventorySection, pvpSection, cursesSection];
        if (indexSection.style.display === 'none') {
          sections.forEach(s => s.style.display = 'none');
          indexSection.style.display = 'block';
          renderIndex();
        } else {
          indexSection.style.display = 'none';
        }
      });

      toggleShopBtn.addEventListener('click', () => {
        const sections = [inventorySection, indexSection, shopSection, merchantSection, itemInventorySection, pvpSection, cursesSection];
        if (shopSection.style.display === 'none') {
          sections.forEach(s => s.style.display = 'none');
          shopSection.style.display = 'block';
          renderShop();
        } else {
          shopSection.style.display = 'none';
        }
      });

      toggleMerchantBtn.addEventListener('click', () => {
        const sections = [inventorySection, indexSection, shopSection, merchantSection, itemInventorySection, pvpSection, cursesSection];
        if (merchantSection.style.display === 'none') {
          sections.forEach(s => s.style.display = 'none');
          merchantSection.style.display = 'block';
          renderMerchant();
        } else {
          merchantSection.style.display = 'none';
        }
      });

      toggleItemInventoryBtn.addEventListener('click', () => {
        const sections = [inventorySection, indexSection, shopSection, merchantSection, itemInventorySection, pvpSection, cursesSection];
        if (itemInventorySection.style.display === 'none') {
          sections.forEach(s => s.style.display = 'none');
          itemInventorySection.style.display = 'block';
          renderItemInventory();
        } else {
          itemInventorySection.style.display = 'none';
        }
      });

      togglePVPBtn.addEventListener('click', () => {
        const sections = [inventorySection, indexSection, shopSection, merchantSection, itemInventorySection, pvpSection, cursesSection];
        if (pvpSection.style.display === 'none') {
          sections.forEach(s => s.style.display = 'none');
          pvpSection.style.display = 'block';
          renderPVPUpgrades();
          updatePVPDisplay();
        } else {
          pvpSection.style.display = 'none';
        }
      });

      toggleCursesBtn.addEventListener('click', () => {
        if (!cursesUnlocked) {
          if (pvpCoins >= 250) {
            if (confirm('Unlock Curses for 250 PVP Coins?')) {
              pvpCoins -= 250;
              cursesUnlocked = true;
              saveAll();
            } else {
              return;
            }
          } else {
            alert('You need 250 PVP Coins to unlock Curses!');
            return;
          }
        }
        
        const sections = [inventorySection, indexSection, shopSection, merchantSection, itemInventorySection, pvpSection, cursesSection];
        if (cursesSection.style.display === 'none') {
          sections.forEach(s => s.style.display = 'none');
          cursesSection.style.display = 'block';
          renderCurses();
        } else {
          cursesSection.style.display = 'none';
        }
      });

      toggleSellModeBtn.addEventListener('click', () => {
        sellMode = !sellMode;
        toggleSellModeBtn.textContent = `Sell Mode: ${sellMode ? 'ON' : 'OFF'}`;
        toggleSellModeBtn.classList.toggle('active', sellMode);
        renderInventory();
      });

      function renderShop() {
        let html = '';
        
        const varCost = Math.floor(100 * Math.pow(1.25, shopUpgrades.variantLuck || 0));
        const varMaxed = (shopUpgrades.variantLuck || 0) >= 32;
        html += `<div class="shop-item">
          <h4>+1x Variant Luck</h4>
          <p>Current: ${variantLuckBonus.toFixed(2)}x</p>
          <p>Cost: ${varCost} Cali-coins</p>
          <p>Upgrades: ${shopUpgrades.variantLuck || 0}/32</p>
          ${varMaxed ? '<p class="maxed">MAXED</p>' : `<button onclick="buyUpgrade('variantLuck')" ${caliCoins < varCost || varMaxed ? 'disabled' : ''}>Buy</button>`}
        </div>`;
        
        const bulkCost = Math.floor(50 * Math.pow(1.05, shopUpgrades.rollBulk));
        const bulkMaxed = shopUpgrades.rollBulk >= 35;
        html += `<div class="shop-item">
          <h4>+1 Bulk Roll</h4>
          <p>Current: Roll ${rollBulk} Times</p>
          <p>Cost: ${bulkCost} Cali-coins</p>
          <p>Upgrades: ${shopUpgrades.rollBulk}/35</p>
          ${bulkMaxed ? '<p class="maxed">MAXED</p>' : `<button onclick="buyUpgrade('rollBulk')" ${caliCoins < bulkCost || bulkMaxed ? 'disabled' : ''}>Buy</button>`}
        </div>`;
        
        const secretCost = Math.floor(100 * Math.pow(1.01, shopUpgrades.secretLuck || 0));
        const secretMaxed = (shopUpgrades.secretLuck || 0) >= 280;
        html += `<div class="shop-item">
          <h4>+0.05x Secret Luck</h4>
          <p>Current: ${secretLuckBonus.toFixed(2)}x</p>
          <p>Cost: ${secretCost} Cali-coins</p>
          <p>Upgrades: ${shopUpgrades.secretLuck || 0}/280</p>
          ${secretMaxed ? '<p class="maxed">MAXED</p>' : `<button onclick="buyUpgrade('secretLuck')" ${caliCoins < secretCost || secretMaxed ? 'disabled' : ''}>Buy</button>`}
        </div>`;
        
        const sellCost = Math.floor(1000 * Math.pow(1000000, shopUpgrades.sellPower || 0));
        const sellMaxed = (shopUpgrades.sellPower || 0) >= 2;
        html += `<div class="shop-item">
          <h4>+0.33 Sell Exponent</h4>
          <p>Current: ^${sellExponent.toFixed(2)}</p>
          <p>Cost: ${sellCost.toLocaleString()} Cali-coins</p>
          <p>Upgrades: ${shopUpgrades.sellPower || 0}/2</p>
          ${sellMaxed ? '<p class="maxed">MAXED</p>' : `<button onclick="buyUpgrade('sellPower')" ${caliCoins < sellCost || sellMaxed ? 'disabled' : ''}>Buy</button>`}
        </div>`;
        
        const specialCost = Math.floor(100 * Math.pow(1.15, shopUpgrades.specialLuck || 0));
        const specialMaxed = (shopUpgrades.specialLuck || 0) >= 100;
        html += `<div class="shop-item">
          <h4>+0.1x Special Rank Luck</h4>
          <p>Current: ${specialLuckBonus.toFixed(2)}x</p>
          <p>Cost: ${specialCost} Cali-coins</p>
          <p>Upgrades: ${shopUpgrades.specialLuck || 0}/100</p>
          ${specialMaxed ? '<p class="maxed">MAXED</p>' : `<button onclick="buyUpgrade('specialLuck')" ${caliCoins < specialCost || specialMaxed ? 'disabled' : ''}>Buy</button>`}
        </div>`;
        
        const generalCost = Math.floor(100 * Math.pow(1.05, shopUpgrades.generalLuck || 0));
        const generalMaxed = (shopUpgrades.generalLuck || 0) >= 1000;
        html += `<div class="shop-item">
          <h4>+0.05x General Luck</h4>
          <p>Current: ${generalLuckBonus.toFixed(2)}x</p>
          <p>Cost: ${generalCost} Cali-coins</p>
          <p>Upgrades: ${shopUpgrades.generalLuck || 0}/1000</p>
          ${generalMaxed ? '<p class="maxed">MAXED</p>' : `<button onclick="buyUpgrade('generalLuck')" ${caliCoins < generalCost || generalMaxed ? 'disabled' : ''}>Buy</button>`}
        </div>`;
        
        html += `<div class="shop-item">
          <h4>Availability</h4>
          <p>Makes ??? rollable</p>
          <p>Cost: 100,000 Cali-coins</p>
          ${shopUpgrades.availability ? '<p class="maxed">PURCHASED</p>' : `<button onclick="buyUpgrade('availability')" ${caliCoins < 100000 || shopUpgrades.availability ? 'disabled' : ''}>Buy</button>`}
        </div>`;
        
        const blessingBonus = calisBlessingActive && totalRolls > 1 ? 
          (blessingBoosterActive ? 
            Math.min(250, Math.pow(Math.log10(totalRolls), 3.33)) : 
            Math.min(5, Math.pow(Math.log10(totalRolls), 0.9))) : 0;
        html += `<div class="shop-item">
          <h4>Cali's Blessing</h4>
          <p>Multiplies all luck by log(rolls)^0.9 (max +5x)</p>
          <p>Current bonus: +${blessingBonus.toFixed(2)}x</p>
          <p>Cost: 777,777 Cali-coins</p>
          ${shopUpgrades.calisBlessing ? '<p class="maxed">PURCHASED</p>' : `<button onclick="buyUpgrade('calisBlessing')" ${caliCoins < 777777 || shopUpgrades.calisBlessing ? 'disabled' : ''}>Buy</button>`}
        </div>`;
        
        html += `<div class="shop-item">
          <h4>'Cali's Blessing' Booster</h4>
          <p>Changes blessing formula to log(rolls)^3.33</p>
          <p>Increases luck cap to +250x (for EVERYTHING)</p>
          <p>Cost: 10,000,000 Cali-coins</p>
          ${!shopUpgrades.calisBlessing ? '<p style="color: #888;">Requires Cali\'s Blessing</p>' : ''}
          ${shopUpgrades.blessingBooster ? '<p class="maxed">PURCHASED</p>' : `<button onclick="buyUpgrade('blessingBooster')" ${caliCoins < 10000000 || shopUpgrades.blessingBooster || !shopUpgrades.calisBlessing ? 'disabled' : ''}>Buy</button>`}
        </div>`;
        
        shopContent.innerHTML = html;
      }

      window.buyUpgrade = function(type) {
        let cost, maxLevel;
        
        if (type === 'variantLuck') {
          cost = Math.floor(100 * Math.pow(1.25, shopUpgrades.variantLuck || 0));
          maxLevel = 32;
          if (caliCoins >= cost && (shopUpgrades.variantLuck || 0) < maxLevel) {
            caliCoins -= cost;
            shopUpgrades.variantLuck = (shopUpgrades.variantLuck || 0) + 1;
            variantLuckBonus = 1 + shopUpgrades.variantLuck;
          }
        } else if (type === 'rollBulk') {
          cost = Math.floor(50 * Math.pow(1.05, shopUpgrades.rollBulk));
          maxLevel = 35;
          if (caliCoins >= cost && shopUpgrades.rollBulk < maxLevel) {
            caliCoins -= cost;
            shopUpgrades.rollBulk++;
            rollBulk = 15 + shopUpgrades.rollBulk;
          }
        } else if (type === 'secretLuck') {
          cost = Math.floor(100 * Math.pow(1.01, shopUpgrades.secretLuck || 0));
          maxLevel = 280;
          if (caliCoins >= cost && (shopUpgrades.secretLuck || 0) < maxLevel) {
            caliCoins -= cost;
            shopUpgrades.secretLuck = (shopUpgrades.secretLuck || 0) + 1;
            secretLuckBonus = 1 + (shopUpgrades.secretLuck * 0.05);
          }
        } else if (type === 'sellPower') {
          cost = Math.floor(1000 * Math.pow(1000000, shopUpgrades.sellPower || 0));
          maxLevel = 2;
          if (caliCoins >= cost && (shopUpgrades.sellPower || 0) < maxLevel) {
            caliCoins -= cost;
            shopUpgrades.sellPower = (shopUpgrades.sellPower || 0) + 1;
            sellExponent = 0.33 + (shopUpgrades.sellPower * 0.33);
          }
        } else if (type === 'specialLuck') {
          cost = Math.floor(100 * Math.pow(1.15, shopUpgrades.specialLuck || 0));
          maxLevel = 100;
          if (caliCoins >= cost && (shopUpgrades.specialLuck || 0) < maxLevel) {
            caliCoins -= cost;
            shopUpgrades.specialLuck = (shopUpgrades.specialLuck || 0) + 1;
            specialLuckBonus = 1 + (shopUpgrades.specialLuck * 0.1);
          }
        } else if (type === 'generalLuck') {
          cost = Math.floor(100 * Math.pow(1.05, shopUpgrades.generalLuck || 0));
          maxLevel = 1000;
          if (caliCoins >= cost && (shopUpgrades.generalLuck || 0) < maxLevel) {
            caliCoins -= cost;
            shopUpgrades.generalLuck = (shopUpgrades.generalLuck || 0) + 1;
            generalLuckBonus = 1 + (shopUpgrades.generalLuck * 0.05);
          }
        } else if (type === 'availability') {
          cost = 100000;
          if (caliCoins >= cost && !shopUpgrades.availability) {
            caliCoins -= cost;
            shopUpgrades.availability = true;
            availabilityUnlocked = true;
          }
        } else if (type === 'calisBlessing') {
          cost = 777777;
          if (caliCoins >= cost && !shopUpgrades.calisBlessing) {
            caliCoins -= cost;
            shopUpgrades.calisBlessing = true;
            calisBlessingActive = true;
          }
        } else if (type === 'blessingBooster') {
          cost = 10000000;
          if (caliCoins >= cost && !shopUpgrades.blessingBooster && shopUpgrades.calisBlessing) {
            caliCoins -= cost;
            shopUpgrades.blessingBooster = true;
            blessingBoosterActive = true;
          }
        }
        
        saveAll();
        renderShop();
      };

      function loadInventory() {
        const saved = localStorage.getItem('calisRngInventory');
        if (saved) {
          try {
            inventory = JSON.parse(saved);
          } catch (e) {
            inventory = [];
          }
        } else {
          inventory = [];
        }
        
        const shopSaved = localStorage.getItem('calisRngShop');
        if (shopSaved) {
          try {
            const shopData = JSON.parse(shopSaved);
            caliCoins = shopData.coins || 0;
            totalRolls = shopData.totalRolls || 0;
            shopUpgrades = shopData.upgrades || { variantLuck: 0, rollBulk: 0, secretLuck: 0, specialLuck: 0, generalLuck: 0, sellPower: 0, availability: false, calisBlessing: false, blessingBooster: false };
            pvpCoins = shopData.pvpCoins || 0;
            winStreak = shopData.winStreak || 0;
            totalWins = shopData.totalWins || 0;
            pvpUpgrades = shopData.pvpUpgrades || { bulkRoll: 0, rngExponent: 0 };
            itemInventory = shopData.itemInventory || [];
            activeCurse = shopData.activeCurse || null;
            cursesUnlocked = shopData.cursesUnlocked || false;
            
            variantLuckBonus = 1 + (shopUpgrades.variantLuck || 0);
            secretLuckBonus = 1 + ((shopUpgrades.secretLuck || 0) * 0.05);
            specialLuckBonus = 1 + ((shopUpgrades.specialLuck || 0) * 0.1);
            generalLuckBonus = 1 + ((shopUpgrades.generalLuck || 0) * 0.05);
            sellExponent = 0.33 + ((shopUpgrades.sellPower || 0) * 0.33);
            rollBulk = 15 + (shopUpgrades.rollBulk || 0) + ((pvpUpgrades.bulkRoll || 0) * 10);
            rngExponent = 1 + ((pvpUpgrades.rngExponent || 0) * 0.1);
            availabilityUnlocked = shopUpgrades.availability || false;
            calisBlessingActive = shopUpgrades.calisBlessing || false;
            blessingBoosterActive = shopUpgrades.blessingBooster || false;
          } catch (e) {
            console.error('Failed to load shop data');
          }
        }
        
        updateCoinsDisplay();
        updateRollCounter();
        updatePVPDisplay();
        renderInventory();
        renderItemInventory();
      }

      function saveAll() {
        localStorage.setItem('calisRngInventory', JSON.stringify(inventory));
        const shopData = {
          coins: caliCoins,
          totalRolls: totalRolls,
          upgrades: shopUpgrades,
          pvpCoins: pvpCoins,
          winStreak: winStreak,
          totalWins: totalWins,
          pvpUpgrades: pvpUpgrades,
          itemInventory: itemInventory,
          activeCurse: activeCurse,
          cursesUnlocked: cursesUnlocked
        };
        localStorage.setItem('calisRngShop', JSON.stringify(shopData));
        updateCoinsDisplay();
        updateRollCounter();
        updatePVPDisplay();
        renderInventory();
        renderItemInventory();
      }

      function updateCoinsDisplay() {
        coinsDisplay.textContent = caliCoins.toFixed(2);
        merchantCoinsDisplay.textContent = caliCoins.toFixed(2);
        cursesCoinsDisplay.textContent = caliCoins.toFixed(2);
        rollMultipleBtn.textContent = `Roll ${rollBulk} Times`;
      }

      function updateRollCounter() {
        rollCounterDisplay.textContent = totalRolls;
      }

      function renderInventory() {
        inventoryGrid.innerHTML = '';
        inventoryCountDisplay.textContent = inventory.length;
        maxSlotsDisplay.textContent = maxSlots;
        
        for (let i = 0; i < maxSlots; i++) {
          const slot = document.createElement('div');
          slot.className = 'inventory-slot';
          
          if (inventory[i]) {
            const item = inventory[i];
            slot.className = 'inventory-slot';
            
            if (item.variants) {
              const varDiv = document.createElement('div');
              varDiv.className = 'slot-variants';
              varDiv.textContent = item.variants;
              slot.appendChild(varDiv);
            }
            
            const valueDiv = document.createElement('div');
            valueDiv.className = 'slot-value';
            if (item.color.startsWith('linear-gradient')) {
              valueDiv.style.background = item.color;
              valueDiv.style.webkitBackgroundClip = 'text';
              valueDiv.style.webkitTextFillColor = 'transparent';
              valueDiv.style.backgroundClip = 'text';
            } else {
              valueDiv.style.color = item.color;
            }
            valueDiv.textContent = item.displayValue;
            slot.appendChild(valueDiv);
            
            const rankDiv = document.createElement('div');
            rankDiv.className = 'slot-rank';
            rankDiv.textContent = item.rank;
            slot.appendChild(rankDiv);
            
            if (sellMode) {
              slot.onclick = () => sellItem(i);
              slot.style.cursor = 'pointer';
              slot.style.borderColor = '#ff6b35';
            } else {
              slot.onclick = () => deleteItem(i);
            }
          } else {
            slot.className = 'inventory-slot empty';
            slot.textContent = 'Empty';
          }
          
          inventoryGrid.appendChild(slot);
        }
      }

      function sellItem(index) {
        if (!inventory[index]) return;
        const item = inventory[index];
        
        const isNormalRank = ALL_RANKS.includes(item.rank) && 
                            !ALL_SPECIAL_RANKS.includes(item.rank) &&
                            !ALL_VARIANT_SECRETS.includes(item.rank);
        const isSecretRank = ALL_SECRET_RANKS.includes(item.rank);
        
        if (!isNormalRank && !isSecretRank) {
          alert('You can only sell normal ranks and secret ranks!');
          return;
        }
        
        let numericValue = parseFloat(item.displayValue.replace(/,/g, ''));
        if (isNaN(numericValue)) {
          alert('Cannot sell this item!');
          return;
        }
        
        const coins = Math.pow(Math.abs(numericValue), sellExponent);
        const finalCoins = activeCurse === 'greed' ? coins * 5 : coins;
        caliCoins += finalCoins;
        
        inventory.splice(index, 1);
        saveAll();
        
        const curseText = activeCurse === 'greed' ? ' (GREED x5)' : '';
        alert(`Sold for ${finalCoins.toFixed(2)} Cali-coins!${curseText}`);
      }

      function deleteItem(index) {
        const now = Date.now();
        const key = `slot_${index}`;
        
        if (lastClickTime[key] && now - lastClickTime[key] < 1000) {
          inventory.splice(index, 1);
          saveAll();
          lastClickTime[key] = 0;
        } else {
          lastClickTime[key] = now;
        }
      }

      function addToInventory(item, buttonId) {
        if (!item) return;
        if (inventory.length >= maxSlots) {
          alert('Inventory full! Delete items or buy more space.');
          return;
        }
        
        inventory.push(item);
        saveAll();
        
        const btn = document.getElementById(buttonId);
        if (btn) {
          btn.classList.add('accepted');
          btn.onclick = null;
        }
      }

      function acceptRoll(index) {
        addToInventory(multiRolls[index], `rank-btn-${index}`);
      }

      window.acceptRoll = acceptRoll;

      function setCooldown(duration) {
        if (isCooldown) return;
        isCooldown = true;
        rollOnceBtn.disabled = true;
        rollMultipleBtn.disabled = true;
        rollSpecialLuckBtn.disabled = true;
        let remaining = duration / 1000;
        const originalText1 = rollOnceBtn.textContent;
        const originalText2 = rollMultipleBtn.textContent;
        const originalText3 = rollSpecialLuckBtn.textContent;

        const interval = setInterval(() => {
          rollOnceBtn.textContent = `Cooldown: ${remaining.toFixed(1)}s`;
          rollMultipleBtn.textContent = `Cooldown: ${remaining.toFixed(1)}s`;
          rollSpecialLuckBtn.textContent = `Cooldown: ${remaining.toFixed(1)}s`;
          remaining -= 0.1;
          if (remaining <= 0) {
            clearInterval(interval);
            rollOnceBtn.disabled = false;
            rollMultipleBtn.disabled = false;
            rollSpecialLuckBtn.disabled = false;
            rollOnceBtn.textContent = originalText1;
            rollMultipleBtn.textContent = originalText2;
            rollSpecialLuckBtn.textContent = originalText3;
            isCooldown = false;
          }
        }, 100);
      }

      function getColor(value) {
        if (value < 100000) return 'white';
        if (value < 10000000) return 'gold';
        if (value < 1000000000) return 'cyan';
        if (value < 1000000000000) return 'purple';
        if (value < 1000000000000000) return 'green';
        if (value < 1e18) return 'red';
        if (value < 1e21) return 'pink';
        if (value < 1e24) return 'orange';
        if (value < 1e30) return 'linear-gradient(90deg, green, white)';
        if (value < 1e33) return 'linear-gradient(45deg, pink, cyan)';
        if (value < 1e36) return 'linear-gradient(0deg, red, black)';
        if (value < 1e39) return 'linear-gradient(90deg, green, pink)';
        if (value < 1e42) return 'linear-gradient(270deg, red, orange, yellow)';
        if (value < 1e45) return 'linear-gradient(45deg, red, white, cyan)';
        if (value < 1e48) return 'linear-gradient(90deg, white, black, white, black, white, black)';
        if (value < 1e51) return 'linear-gradient(75deg, red, pink, red, pink)';
        if (value < 1e54) return 'linear-gradient(90deg, red, pink, white, pink, red)';
        if (value < 1e57) return 'linear-gradient(150deg, cyan, green, red, white)';
        if (value < 1e60) return 'linear-gradient(90deg, purple, black, purple, black, purple, black, purple)';
        if (value < 1e63) return 'linear-gradient(90deg, blue, cyan, blue, cyan)';
        if (value < 1e66) return 'linear-gradient(90deg, red, orange, red, orange)';
        if (value < 1e69) return 'linear-gradient(90deg, pink, white, pink, white)';
        if (value < 1e72) return 'linear-gradient(150deg, green, orange, red)';
        return 'linear-gradient(90deg, red, orange, yellow, green, cyan, blue, violet)';
      }

      function rollOnce(luckMultiplier = 1, variantLuckMultiplier = 1, secretLuckMultiplier = 1, isCheese = false) {
        if (Math.random() < 1/900900900.900 * specialLuckBonus) {
          markDiscovered('specialRanks', 'EZ');
          const invData = {
            variants: '',
            displayValue: 'Lel',
            rank: 'EZ',
            color: '#4ade80'
          };
          return { result: '<span class="bold" style="color: #4ade80;">You rolled a/an RANKBUTTON (Lel)!</span>', cooldown: 0, inventoryData: invData };
        }
        
        if (Math.random() < 1/100000000000000 * specialLuckBonus) {
          markDiscovered('specialRanks', 'The Great Special Rank With An Unnecessary Long Name, Anyways Are You Even Reading This? I Bet Not. If You Are Good Job Cuz You Wasted Time On This, Why? Anyways, Be Happy You Rolled This. Its The Rarest Special Rank. Haha I Am Making You Read This Weird Rank Name Anyways So What? Its Just A RNG Game Rank Anyways  Just Stop. You Did Too Much Reading For A Simple RNG Game Bro I Am Telling You Stop Its Just A Rank Of All Things');
          const invData = {
            variants: '',
            displayValue: '100 Trillion',
            rank: 'The Great Special Rank With An Unnecessary Long Name, Anyways Are You Even Reading This? I Bet Not. If You Are Good Job Cuz You Wasted Time On This, Why? Anyways, Be Happy You Rolled This. Its The Rarest Special Rank. Haha I Am Making You Read This Weird Rank Name Anyways So What? Its Just A RNG Game Rank Anyways  Just Stop. You Did Too Much Reading For A Simple RNG Game Bro I Am Telling You Stop Its Just A Rank Of All Things',
            color: 'linear-gradient(90deg, red, orange, yellow, green, cyan, blue, violet)'
          };
          return { result: '<span class="bold" style="background: linear-gradient(90deg, red, orange, yellow, green, cyan, blue, violet); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">You rolled a/an RANKBUTTON (100 Trillion)!</span>', cooldown: 100000, inventoryData: invData };
        }
        
        if (Math.random() < 1/100000 * specialLuckBonus) {
          markDiscovered('specialRanks', '100');
          const invData = {
            variants: '',
            displayValue: 'ðŸ’¯',
            rank: '100',
            color: '#fbbf24'
          };
          return { result: '<span class="bold" style="color: #fbbf24;">You rolled a/an RANKBUTTON (ðŸ’¯)!</span>', cooldown: 0, inventoryData: invData };
        }
        
        if (Math.random() < 1/890000) {
          markDiscovered('specialRanks', 'pepeCringe');
          const invData = {
            variants: '',
            displayValue: 'ðŸ¸',
            rank: 'pepeCringe',
            color: '#4ade80'
          };
          return { result: '<span class="bold" style="color: #4ade80;">You rolled a/an RANKBUTTON (ðŸ¸)!</span>', cooldown: 3000, inventoryData: invData };
        }
        
        if (activeCurse === 'greed') {
          luckMultiplier /= 10;
          variantLuckMultiplier /= 10;
          secretLuckMultiplier /= 10;
        }
        
        const hasYinYang = itemInventory.some(item => item.type === 'yinYang');
        if (hasYinYang) {
          if (yinYangState === 'normal') {
            luckMultiplier *= 100;
            secretLuckMultiplier = 0;
          } else {
            luckMultiplier = 0;
            secretLuckMultiplier *= 100000;
          }
        }
        
        luckMultiplier *= generalLuckBonus;
        secretLuckMultiplier *= generalLuckBonus;
        
        let blessingBonus = 0;
        if (calisBlessingActive && totalRolls > 1) {
          if (blessingBoosterActive) {
            blessingBonus = Math.min(250, Math.pow(Math.log10(totalRolls), 3.33));
          } else {
            blessingBonus = Math.min(5, Math.pow(Math.log10(totalRolls), 0.9));
          }
        }
        
        luckMultiplier += blessingBonus;
        secretLuckMultiplier += blessingBonus;
        
        let isSpecial = false;
        let noCooldownRanks = ['???UNKNOWN???', 'nil', 'Lmao'];
        let originalValue = null;

        if (isCheese) {
          isSpecial = true;
          markDiscovered('specialRanks', 'Cheesium');
          const invData = {
            variants: '',
            displayValue: 'ðŸ§€',
            rank: 'Cheesium',
            color: '#FFD700'
          };
          return { result: '<span class="bold" style="color: #FFD700;">You rolled a/an RANKBUTTON (ðŸ§€)!</span>', cooldown: 2500, inventoryData: invData };
        }

        if (Math.random() < (1 / 15629519) * specialLuckBonus) {
          isSpecial = true;
          markDiscovered('specialRanks', 'RNGarbage');
          const invData = {
            variants: '',
            displayValue: 'Bum..',
            rank: 'RNGarbage',
            color: 'brown'
          };
          return { result: '<span class="bold" style="color: brown;">You rolled a/an RANKBUTTON (Bum..)!</span>', cooldown: 2500, inventoryData: invData };
        }

        if (Math.random() < (1 / 1000000) * specialLuckBonus) {
          isSpecial = true;
          markDiscovered('specialRanks', 'RNGod');
          const invData = {
            variants: '',
            displayValue: '1.0000e+6',
            rank: 'RNGod',
            color: 'gold'
          };
          return { result: '<span class="bold" style="color: gold;">You rolled a/an RANKBUTTON (1.0000e+6)!</span>', cooldown: 5000, inventoryData: invData };
        }

        if (Math.random() < (1 / 575765100) * specialLuckBonus) {
          isSpecial = true;
          markDiscovered('specialRanks', 'Everlasting');
          const invData = {
            variants: '',
            displayValue: '0i',
            rank: 'Everlasting',
            color: 'cyan'
          };
          return { result: '<span class="bold" style="color: cyan;">You rolled a/an RANKBUTTON (0i)!</span>', cooldown: 2500, inventoryData: invData };
        }

        if (Math.random() < (1 / 1000000000) * specialLuckBonus) {
          isSpecial = true;
          markDiscovered('specialRanks', 'UNOBTAINABLE');
          const invData = {
            variants: '',
            displayValue: '1.0000e+9',
            rank: 'UNOBTAINABLE',
            color: 'red'
          };
          return { result: '<span class="bold" style="color: red;">You rolled a/an RANKBUTTON (1.0000e+9)!</span>', cooldown: 2500, inventoryData: invData };
        }

        if (Math.random() < (1 / 75000000) * specialLuckBonus) {
          isSpecial = true;
          markDiscovered('specialRanks', 'Legacy FINALE');
          const invData = {
            variants: '',
            displayValue: '1.0000e+10',
            rank: 'Legacy FINALE',
            color: 'gold'
          };
          return { result: '<span class="bold" style="color: gold;">You rolled a/an RANKBUTTON (1.0000e+10)!</span>', cooldown: 5000, inventoryData: invData };
        }

        if (Math.random() < (1 / 77777777) * specialLuckBonus) {
          isSpecial = true;
          markDiscovered('specialRanks', '<(ETERNAL DAWN)>');
          const invData = {
            variants: '',
            displayValue: '-777,777,777.77',
            rank: '<(ETERNAL DAWN)>',
            color: 'purple'
          };
          return { result: '<span class="bold" style="color: purple;">You rolled a/an RANKBUTTON (-777,777,777.78)!</span>', cooldown: 4500, inventoryData: invData };
        }

        if (Math.random() < (1 / 3906250) * specialLuckBonus) {
          isSpecial = true;
          markDiscovered('specialRanks', 'Catastrophic');
          const invData = {
            variants: '',
            displayValue: '-0.50',
            rank: 'Catastrophic',
            color: 'red'
          };
          return { result: '<span class="bold" style="color: red;">You rolled a/an RANKBUTTON (-0.50)!</span>', cooldown: 3500, inventoryData: invData };
        }

        if (Math.random() < (1 / 3750000) * specialLuckBonus) {
          isSpecial = true;
          markDiscovered('specialRanks', 'In im table ?!?!?');
          const invData = {
            variants: '',
            displayValue: '1einf',
            rank: 'In im table ?!?!?',
            color: 'white'
          };
          return { result: '<span class="bold">You rolled a/an RANKBUTTON (1einf)!</span>', cooldown: 2500, inventoryData: invData };
        }

        if (Math.random() < (1 / 1234567) * specialLuckBonus) {
          isSpecial = true;
          markDiscovered('specialRanks', '???UNKNOWN???');
          const invData = {
            variants: '',
            displayValue: '???',
            rank: '???UNKNOWN???',
            color: 'white'
          };
          return { result: '<span class="bold">You rolled a/an RANKBUTTON (???)!</span>', cooldown: 0, inventoryData: invData };
        }

        if (Math.random() < (1 / 5000000) * specialLuckBonus) {
          isSpecial = true;
          originalValue = Math.random() * 50000000;
          markDiscovered('specialRanks', 'Invisible');
          const invData = {
            variants: '',
            displayValue: originalValue.toFixed(2),
            rank: 'Invisible',
            color: 'rgba(255, 192, 203, 0.2)'
          };
          return { result: '<span class="bold" style="color: rgba(255, 192, 203, 0.2);">You rolled a/an RANKBUTTON (' + originalValue.toFixed(2) + ')!</span>', cooldown: 2500, inventoryData: invData };
        }

        let base = Math.random();
        let skewed;
        if (base < 0.5) skewed = 1 + Math.random() * 180;
        else if (base < 0.75) skewed = 10 + Math.random() * 1800;
        else if (base < 0.90) skewed = 100 + Math.random() * 18000;
        else if (base < 0.97) skewed = 1000 + Math.random() * 180000;
        else if (base < 0.99) skewed = 10000 + Math.random() * 1800000;
        else if (base < 0.997) skewed = 100000 + Math.random() * 18000000;
        else if (base < 0.9995) skewed = 1000000 + Math.random() * 180000000;
        else skewed = 10000000 + Math.random() * 18000000000;

        skewed = Math.max(1, skewed);
        if (Math.random() < 1 / 1000) skewed = -1;

        let isNegative = false;
        if (skewed > 1 && Math.random() < 0.075) {
          skewed = -skewed;
          isNegative = true;
        }

        let isReverted = false;
        if (Math.random() < 1 / 75 && skewed !== 0 && skewed !== -1) {
          const originalVal = skewed;
          skewed = 1 / skewed;
          isReverted = true;
          var revertedOriginal = originalVal;
        }

        const baseValue = skewed;
        const absBaseValue = Math.abs(baseValue);
        originalValue = originalValue || baseValue;

        let secretRank = null;
        let secretMultiplier = 1;

        if (Math.random() < (1 / 88888) * secretLuckMultiplier) {
          secretRank = 'ULTIMATE';
          secretMultiplier = 750;
          markDiscovered('secretRanks', 'ULTIMATE');
        } else if (Math.random() < (1 / 40000) * secretLuckMultiplier) {
          secretRank = 'ðŸŒ³';
          secretMultiplier = 400;
          markDiscovered('secretRanks', 'ðŸŒ³');
        } else if (Math.random() < (1 / 9999) * secretLuckMultiplier) {
          secretRank = 'Destiny';
          secretMultiplier = 99.99;
          markDiscovered('secretRanks', 'Destiny');
        } else if (Math.random() < (1 / 6942) * secretLuckMultiplier) {
          secretRank = 'ðŸŸ';
          secretMultiplier = 10;
          markDiscovered('secretRanks', 'ðŸŸ');
        }

        const variants = [
          { name: 'shiny', chance: 1 / 100, multiplier: 100 },
          { name: 'Modified', chance: 1 / 250, multiplier: 250 },
          { name: 'golden', chance: 1 / 500, multiplier: 500 },
          { name: 'Colorful', chance: 1 / 777, multiplier: 777 },
          { name: 'inverse', chance: 1 / 1000, multiplier: 1000 },
          { name: 'retro', chance: 1 / 2500, multiplier: 2500 },
          { name: 'bright', chance: 1 / 5000, multiplier: 5000 },
          { name: 'cosmic', chance: 1 / 10000, multiplier: 10000 },
          { name: 'GIGANTIC', chance: 1 / 25000, multiplier: 25000 },
          { name: 'h o r s e', chance: 1 / 30000, multiplier: 1 / 10 },
          { name: 'eternal', chance: 1 / 50000, multiplier: 50000 },
          { name: 'dark', chance: 1 / 77777, multiplier: 77777 },
          { name: 'UNIVERSAL', chance: 1 / 100000, multiplier: 100000 },
          { name: 'Gargantuan', chance: 1 / 300000, multiplier: 300000 },
          { name: 'Possible', chance: 1 / 500000, multiplier: 500000 },
          { name: 'Gigaconfuscibretrationiminousis', chance: 1 / 1000000, multiplier: 1000000 },
          { name: 'Ethereal', chance: 1 / 2500000, multiplier: 2500000 },
          { name: 'Limitless', chance: 1 / 10000000, multiplier: 10000000 },
          { name: 'INFINITUM', chance: 1 / 1e18, multiplier: 1e18 },
          { name: 'evil', chance: 1 / 69420, multiplier: 1.01 },
          { name: 'Light', chance: 1 / 7500, multiplier: 7500 },
          { name: 'void.', chance: 1 / 1000000000, multiplier: 1000000000 },
          { name: 'Unhonored', chance: 1 / 666666, multiplier: 666666 },
          { name: 'REALITY', chance: 1 / 100000000, multiplier: 100000000 }
        ];

        let variantText = '';
        let variantMultiplier = 1;
        let discoveredVariants = [];

        variants.forEach(v => {
          if (Math.random() < v.chance * variantLuckMultiplier * variantLuckBonus) {
            variantMultiplier *= v.multiplier;
            variantText += `[${v.name.toUpperCase()}] `;
            discoveredVariants.push(v.name);
            markDiscovered('variants', v.name);
          }
        });

        let variantSecret = null;
        let variantSecretMultiplier = 1;
        let removeVariant = null;

        if (discoveredVariants.includes('Gigaconfuscibretrationiminousis')) {
          if (Math.random() < 1 / 2.5) {
            variantSecret = 'COLOSSAL';
            variantSecretMultiplier = 25000000;
            removeVariant = 'Gigaconfuscibretrationiminousis';
            markDiscovered('variantSecrets', 'COLOSSAL');
            isSpecial = true;
          }
        }

        let rank = '';
        let displayValue = baseValue;

        if (Math.random() < 1 / 98900 * specialLuckBonus) { 
          rank = 'INSANE'; 
          displayValue = 0.989; 
          originalValue = 0.989;
          isSpecial = true;
          markDiscovered('specialRanks', 'INSANE');
        }
        else if (Math.random() < 1 / 150000 * specialLuckBonus) { 
          rank = 'Lmao'; 
          displayValue = 0.1;
          originalValue = 0.1;
          isSpecial = true;
          markDiscovered('specialRanks', 'Lmao');
        }
        else if (Math.abs(baseValue - 5000) < 0.01) { 
          rank = 'PERFECTIONIST';
          originalValue = 5000;
          isSpecial = true;
          markDiscovered('specialRanks', 'PERFECTIONIST');
        }
        else if (Math.random() < 1 / 88888 * specialLuckBonus) { 
          rank = "Imaginary"; 
          displayValue = "0.1i";
          originalValue = 0.1;
          isSpecial = true;
          markDiscovered('specialRanks', 'Imaginary');
        }
        else if (baseValue === -1) { 
          if (Math.random() < 1 / 25) {
            rank = 'NOTHINGNESS';
            displayValue = '-error';
            originalValue = '-error';
            isSpecial = true;
            markDiscovered('specialRanks', 'NOTHINGNESS');
          } else {
            rank = 'nil';
            displayValue = -1;
            originalValue = -1;
            isSpecial = true;
            markDiscovered('specialRanks', 'nil');
          }
        }
        else if (Math.abs(baseValue - 1) < 0.0001) {
          rank = 'nothing';
          markDiscovered('ranks', 'nothing');
        }
        else if (Math.random() < 1 / 690000 * specialLuckBonus) { 
          rank = 'NICE';
          displayValue = 69;
          originalValue = 69;
          isSpecial = true;
          markDiscovered('specialRanks', 'NICE');
        }
        else if (Math.random() < 1 / 6942000 * specialLuckBonus) { 
          rank = 'FUNNY';
          displayValue = 69420;
          originalValue = 69420;
          isSpecial = true;
          markDiscovered('specialRanks', 'FUNNY');
        }
        else if (absBaseValue < 5) {
          if (Math.random() < 1 / 3333333 * specialLuckBonus) { 
            rank = 'Common : DIVINITY'; 
            displayValue *= 5e5;
            isSpecial = true;
            markDiscovered('specialRanks', 'Common : DIVINITY');
          }
          else { 
            rank = 'Common';
            markDiscovered('ranks', 'Common');
          }
        }
        else if (absBaseValue < 25) { rank = 'Natural'; markDiscovered('ranks', 'Natural'); }
        else if (absBaseValue < 50) { rank = 'Rare'; markDiscovered('ranks', 'Rare'); }
        else if (absBaseValue < 80000) { rank = 'Unnatural'; markDiscovered('ranks', 'Unnatural'); }
        else if (absBaseValue < 100000) { rank = 'Microb'; markDiscovered('ranks', 'Microb'); }
        else if (absBaseValue < 250) { rank = 'Epic'; markDiscovered('ranks', 'Epic'); }
        else if (absBaseValue < 500) { rank = 'Decent'; markDiscovered('ranks', 'Decent'); }
        else if (absBaseValue < 1000) { rank = 'Mythical'; markDiscovered('ranks', 'Mythical'); }
        else if (absBaseValue < 5000) { rank = 'Legendary'; markDiscovered('ranks', 'Legendary'); }
        else if (absBaseValue < 10000) { rank = 'Unreal'; markDiscovered('ranks', 'Unreal'); }
        else if (absBaseValue < 50000) { rank = 'Super Rare'; markDiscovered('ranks', 'Super Rare'); }
        else if (absBaseValue < 100000) { rank = 'Eternal'; markDiscovered('ranks', 'Eternal'); }
        else if (absBaseValue < 250000) { rank = 'Attainable'; markDiscovered('ranks', 'Attainable'); }
        else if (absBaseValue < 500000) { rank = 'Starstruck'; markDiscovered('ranks', 'Starstruck'); }
        else if (absBaseValue < 777777) { rank = 'Paradoxical'; markDiscovered('ranks', 'Paradoxical'); }
        else if (absBaseValue < 788888) { rank = 'Directional'; markDiscovered('ranks', 'Directional'); }
        else if (absBaseValue < 1000000) { rank = 'Limitless'; markDiscovered('ranks', 'Limitless'); }
        else if (absBaseValue < 5000000) { rank = 'Iridescent'; markDiscovered('ranks', 'Iridescent'); }
        else if (absBaseValue < 10000000) { rank = 'Endless'; markDiscovered('ranks', 'Endless'); }
        else if (absBaseValue < 50000000) { rank = 'Lux'; markDiscovered('ranks', 'Lux'); }
        else if (absBaseValue < 100000000) { rank = 'Possible'; markDiscovered('ranks', 'Possible'); }
        else if (absBaseValue < 250000000) { rank = 'RNGesus'; markDiscovered('ranks', 'RNGesus'); }
        else if (absBaseValue < 1000000000) { rank = 'CRAZY'; markDiscovered('ranks', 'CRAZY'); }
        else if (absBaseValue < 1e10) { rank = 'Supreme'; markDiscovered('ranks', 'Supreme'); }
        else if (absBaseValue < 1e12) { rank = 'DAMN'; markDiscovered('ranks', 'DAMN'); }
        else if (absBaseValue < 1e15) { rank = 'Stupiditium'; markDiscovered('ranks', 'Stupiditium'); }
        else if (absBaseValue < 1e18) { rank = 'ASCENDED'; markDiscovered('ranks', 'ASCENDED'); }
        else if (absBaseValue < 1e21) { rank = 'Obscure'; markDiscovered('ranks', 'Obscure'); }
        else if (absBaseValue < 1e30) { rank = 'INFINITE'; markDiscovered('ranks', 'INFINITE'); }
        else if (absBaseValue < 1e50) { rank = 'Divine'; markDiscovered('ranks', 'Divine'); }
        else if (absBaseValue < 1e75) { rank = 'Insurmountable'; markDiscovered('ranks', 'Insurmountable'); }
        else if (absBaseValue < 1e100) { rank = 'GRAND'; markDiscovered('ranks', 'GRAND'); }
        else if (absBaseValue < 1e150) { rank = 'what.'; markDiscovered('ranks', 'what.'); }
        else { rank = 'FINALE'; markDiscovered('ranks', 'FINALE'); }

        if (Math.random() < (1 / 276300 * specialLuckBonus)) {
          isSpecial = true;
          rank = 'leaflet';
          displayValue = 2763;
          originalValue = 2763;
          markDiscovered('specialRanks', 'leaflet');
        }

        let dispValue;
        if (isSpecial && !['leaflet', 'Common : DIVINITY'].includes(rank) && originalValue !== null) {
          if (typeof originalValue === 'string') {
            dispValue = originalValue;
          } else if (typeof originalValue === 'number') {
            if (Math.abs(originalValue) >= 1e45) {
              dispValue = originalValue.toExponential(4);
            } else if (Math.abs(originalValue) >= 1000) {
              dispValue = originalValue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            } else {
              dispValue = originalValue.toFixed(2);
            }
          } else {
            dispValue = originalValue;
          }
        } else if (typeof displayValue === 'string') {
          dispValue = displayValue;
        } else if (typeof displayValue === 'number') {
          if (isReverted) {
            const exponent = Math.floor(Math.log10(Math.abs(displayValue)));
            const mantissa = Math.abs(displayValue) / Math.pow(10, exponent);
            dispValue = `${mantissa.toFixed(2)}e${exponent}`;
          } else if (Math.abs(displayValue) >= 1e45) {
            dispValue = displayValue.toExponential(4);
          } else if (Math.abs(displayValue) >= 1000) {
            dispValue = displayValue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
          } else {
            dispValue = displayValue.toFixed(2);
          }
        } else {
          dispValue = displayValue;
        }

        if (typeof displayValue !== 'string' && variantMultiplier !== 1) {
          displayValue = displayValue * variantMultiplier;
        }

        if (secretRank && typeof displayValue === 'number') {
          displayValue = displayValue * secretMultiplier;
        }

        if (variantSecret && typeof displayValue === 'number') {
          displayValue = displayValue * variantSecretMultiplier;
        }

        const absDisplayValue = typeof displayValue === 'number' ? Math.abs(displayValue) : 0;

        if (typeof displayValue === 'string') {
          dispValue = displayValue;
        } else if (typeof displayValue === 'number') {
          if (isReverted) {
            const exponent = Math.floor(Math.log10(Math.abs(displayValue)));
            const mantissa = Math.abs(displayValue) / Math.pow(10, exponent);
            dispValue = `${mantissa.toFixed(2)}e${exponent}`;
          } else if (Math.abs(displayValue) >= 1e12) {
            dispValue = displayValue.toExponential(4);
          } else if (Math.abs(displayValue) >= 1000) {
            dispValue = displayValue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
          } else {
            dispValue = displayValue.toFixed(2);
          }
        }

        let result = '';
        let invVariants = '';
        
        if (removeVariant) {
          const removeIndex = discoveredVariants.indexOf(removeVariant);
          if (removeIndex > -1) {
            discoveredVariants.splice(removeIndex, 1);
          }
          variantText = '';
          discoveredVariants.forEach(v => {
            variantText += `[${v.toUpperCase()}] `;
          });
        }
        
        if (variantText) {
          result += variantText;
          invVariants = variantText.trim();
        }
        if (variantSecret) {
          result += `<${variantSecret}> `;
          if (invVariants) invVariants += ' ';
          invVariants += `<${variantSecret}>`;
        }
        if (secretRank) {
          result += `{${secretRank}} `;
          if (invVariants) invVariants += ' ';
          invVariants += `{${secretRank}}`;
        }
        if (isNegative) result += '[NEGATIVE] ';
        if (isReverted) result += '[REVERTED] ';
        const color = getColor(absDisplayValue);

        const rankButton = `<button class="rank-button" id="rank-btn-ROLLINDEX" onclick="acceptRoll(ROLLINDEX)">${rank}</button>`;

        if (['Lmao','FUNNY','NICE','nil','NOTHINGNESS','PERFECTIONIST','In im table ?!?!?','INSANE','Common : DIVINITY','Imaginary','???UNKNOWN???','Legacy FINALE','Catastrophic','<(ETERNAL DAWN)>','UNOBTAINABLE','Everlasting','RNGod','Invisible','cali','RNGarbage','leaflet','Cheesium','pepeCringe','EZ','The Great Special Rank With An Unnecessary Long Name, Anyways Are You Even Reading This? I Bet Not. If You Are Good Job Cuz You Wasted Time On This, Why? Anyways, Be Happy You Rolled This. Its The Rarest Special Rank. Haha I Am Making You Read This Weird Rank Name Anyways So What? Its Just A RNG Game Rank Anyways  Just Stop. You Did Too Much Reading For A Simple RNG Game Bro I Am Telling You Stop Its Just A Rank Of All Things','100'].includes(rank)) {
          if (color.startsWith('linear-gradient')) {
            result += `<span class="bold" style="background: ${color}; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">You rolled a/an RANKBUTTON (${dispValue})!</span>`;
          } else {
            result += `<span class="bold" style="color:${color};">You rolled a/an RANKBUTTON (${dispValue})!</span>`;
          }
        } else {
          if (color.startsWith('linear-gradient')) {
            result += `<span style="background: ${color}; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">You rolled a/an ${dispValue} RANKBUTTON!</span>`;
          } else {
            result += `<span style="color:${color};">You rolled a/an ${dispValue} RANKBUTTON!</span>`;
          }
        }

        let cooldown = 0;
        if (isSpecial && !noCooldownRanks.includes(rank)) {
          cooldown = 100;
        } else if (absDisplayValue >= 1e35) {
          cooldown = 1500;
        }

        const inventoryData = {
          variants: invVariants,
          displayValue: dispValue,
          rank: rank,
          color: color
        };

        return { result, cooldown, inventoryData };
      }

      rollOnceBtn.addEventListener('click', () => {
        if (isCooldown) return;
        multiRolls = [];
        totalRolls++;
        saveAll();
        const roll = rollOnce(25, 25, 100 * secretLuckBonus);
        multiRolls.push(roll.inventoryData);
        
        let displayResult = roll.result.replace(/ROLLINDEX/g, '0').replace(/RANKBUTTON/g, roll.inventoryData ? 
          `<button class="rank-button" id="rank-btn-0" onclick="acceptRoll(0)">${roll.inventoryData.rank}</button>` : 
          roll.inventoryData ? roll.inventoryData.rank : '???');
        
        resultsDiv.innerHTML = displayResult;
        if (roll.cooldown > 0) setCooldown(roll.cooldown);
      });

      rollMultipleBtn.addEventListener('click', () => {
        if (isCooldown) return;
        let maxCooldown = 0;
        let output = '';
        multiRolls = [];
        
        for (let i = 0; i < rollBulk; i++) {
          totalRolls++;
          const roll = rollOnce(30, 25, 5 * secretLuckBonus);
          multiRolls.push(roll.inventoryData);
          
          let displayResult = roll.result.replace(/ROLLINDEX/g, i.toString()).replace(/RANKBUTTON/g, roll.inventoryData ? 
            `<button class="rank-button" id="rank-btn-${i}" onclick="acceptRoll(${i})">${roll.inventoryData.rank}</button>` : 
            '???');
          
          output += `<div class="roll-line">${displayResult}</div>`;
          if (roll.cooldown > maxCooldown) maxCooldown = roll.cooldown;
        }
        
        saveAll();
        resultsDiv.innerHTML = output;
        if (maxCooldown > 0) setCooldown(maxCooldown);
      });

      rollSpecialLuckBtn.addEventListener('click', () => {
        if (isCooldown) return;
        if (caliCoins < 1e35) {
          alert('Not enough coins! You need 1e35 Cali-coins.');
          return;
        }
        
        caliCoins -= 1e35;
        multiRolls = [];
        totalRolls++;
        saveAll();
        const roll = rollOnce(10, 10, 1000000 * secretLuckBonus);
        multiRolls.push(roll.inventoryData);
        
        let displayResult = roll.result.replace(/ROLLINDEX/g, '0').replace(/RANKBUTTON/g, roll.inventoryData ? 
          `<button class="rank-button" id="rank-btn-0" onclick="acceptRoll(0)">${roll.inventoryData.rank}</button>` : 
          roll.inventoryData ? roll.inventoryData.rank : '???');
        
        resultsDiv.innerHTML = '<span style="color: gold;">SUPER LUCK ROLL!</span><br>' + displayResult;
        if (roll.cooldown > 0) setCooldown(roll.cooldown);
      });

      window.acceptRoll = acceptRoll;

      loadDiscovered();
      loadInventory();
      generateMerchantStock();
      renderMerchant();
    </script>
  </body>
</html>
