<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>calis rng</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Balthazar:wght@400;700&display=swap');

      body {
        font-family: 'Balthazar', serif;
        margin: 0;
        padding: 0;
        background: #6a0dad;
        color: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
      }

      .game-container {
        background: #2c2c2c;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        min-width: 350px;
        max-width: 900px;
      }

      button {
        padding: 10px 20px;
        margin: 5px;
        font-size: 16px;
        cursor: pointer;
        background-color: #c71585;
        color: #fff;
        border: none;
        border-radius: 5px;
        transition: background-color 0.3s;
        font-family: 'Balthazar', serif;
        font-weight: 700;
      }

      button:disabled {
        background-color: #555;
        cursor: not-allowed;
      }

      button:hover:not(:disabled) {
        background-color: #e754bb;
      }

      #results {
        margin-top: 20px;
        white-space: pre-line;
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 5px;
        min-height: 100px;
        font-family: 'Balthazar', serif;
      }

      .bold {
        font-weight: 700;
      }

      .roll-line {
        margin: 5px 0;
      }

      .rank-button {
        background: none;
        border: 2px solid #28a745;
        color: inherit;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 3px;
        font-family: 'Balthazar', serif;
        transition: all 0.2s;
        display: inline;
      }

      .rank-button:hover {
        background-color: rgba(40, 167, 69, 0.2);
        border-color: #34d058;
      }

      .rank-button.accepted {
        opacity: 0.3;
        cursor: default;
        border-color: #555;
      }

      .rank-button.accepted:hover {
        background: none;
        border-color: #555;
      }

      .inventory-section {
        margin-top: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      }

      .inventory-grid {
        display: grid;
        grid-template-columns: repeat(5, 50fr);
        gap: 5px;
        margin-top: 15px;
      }

      .inventory-slot {
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid #555;
        border-radius: 5px;
        padding: 5px;
        min-height: 40px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .inventory-slot:hover {
        background: rgba(0, 0, 0, 0.5);
        border-color: #888;
      }

      .inventory-slot.empty {
        cursor: default;
        opacity: 0.5;
      }

      .inventory-slot.empty:hover {
        background: rgba(0, 0, 0, 0.3);
        border-color: #555;
      }

      .slot-variants {
        font-size: 8px;
        margin-bottom: 2px;
        color: #ffd700;
      }

      .slot-value {
        font-weight: 700;
        margin-bottom: 2px;
        font-size: 9px;
      }

      .slot-rank {
        font-size: 9px;
        opacity: 0.8;
      }

      .index-section {
        margin-top: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        max-height: 500px;
        overflow-y: auto;
      }

      .index-category {
        margin-bottom: 20px;
        text-align: left;
      }

      .index-category h3 {
        margin-bottom: 10px;
        color: #c71585;
      }

      .index-item {
        padding: 5px;
        margin: 3px 0;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
      }

      .index-item.discovered {
        color: #4ade80;
      }

      .index-item.undiscovered {
        color: #666;
      }

      #toggleIndex {
        margin-top: 10px;
        background-color: #6a0dad;
      }

      #toggleIndex:hover {
        background-color: #8a2dcd;
      }

      #toggleShop {
        margin-top: 10px;
        background-color: #d4af37;
        color: #000;
      }

      #toggleShop:hover {
        background-color: #f0c748;
      }

      #toggleSellMode {
        background-color: #ff6b35;
      }

      #toggleSellMode:hover {
        background-color: #ff8555;
      }

      #toggleSellMode.active {
        background-color: #ff3333;
      }

      .shop-section {
        margin-top: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      }

      .coins-display {
        font-size: 24px;
        font-weight: 700;
        color: #d4af37;
        margin-bottom: 20px;
      }

      .shop-item {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        border: 2px solid #555;
      }

      .shop-item h4 {
        margin: 0 0 10px 0;
        color: #fff;
      }

      .shop-item p {
        margin: 5px 0;
        font-size: 14px;
      }

      .shop-item button {
        margin-top: 10px;
        background-color: #d4af37;
        color: #000;
      }

      .shop-item button:hover:not(:disabled) {
        background-color: #f0c748;
      }

      .shop-item button:disabled {
        background-color: #555;
        color: #888;
      }

      .maxed {
        color: #4ade80;
        font-weight: 700;
      }

      .roll-counter {
        margin-bottom: 15px;
        font-size: 18px;
        color: #d4af37;
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <h1>calis rng game</h1>
      <div class="roll-counter">
        Total Rolls: <span id="rollCounter">0</span>
      </div>
      <button id="rollOnceBtn">Roll Once</button>
      <button id="rollMultipleBtn">Roll 15 Times</button>
      <button id="toggleInventory">Toggle Inventory</button>
      <button id="toggleIndex">Toggle Index</button>
      <button id="toggleShop">Toggle Shop</button>
      <button id="toggleSellMode">Sell Mode: OFF</button>

      <div id="results"></div>

      <div class="inventory-section" id="inventorySection" style="display: none;">
        <h2>Inventory (<span id="inventoryCount">0</span>/<span id="maxSlotsDisplay">250</span> slots)</h2>
        <div class="inventory-grid" id="inventoryGrid"></div>
      </div>

      <div class="shop-section" id="shopSection" style="display: none;">
        <h2>Shop</h2>
        <div class="coins-display">Cali-coins: <span id="coinsDisplay">0</span></div>
        <div id="shopContent"></div>
      </div>

      <div class="index-section" id="indexSection" style="display: none;">
        <h2>Discovery Index</h2>
        <div id="indexContent"></div>
      </div>
    </div>

    <script>
      const resultsDiv = document.getElementById('results');
      const rollOnceBtn = document.getElementById('rollOnceBtn');
      const rollMultipleBtn = document.getElementById('rollMultipleBtn');
      const toggleInventoryBtn = document.getElementById('toggleInventory');
      const toggleIndexBtn = document.getElementById('toggleIndex');
      const toggleShopBtn = document.getElementById('toggleShop');
      const toggleSellModeBtn = document.getElementById('toggleSellMode');
      const inventorySection = document.getElementById('inventorySection');
      const indexSection = document.getElementById('indexSection');
      const shopSection = document.getElementById('shopSection');
      const indexContent = document.getElementById('indexContent');
      const shopContent = document.getElementById('shopContent');
      const coinsDisplay = document.getElementById('coinsDisplay');
      const inventoryCountDisplay = document.getElementById('inventoryCount');
      const maxSlotsDisplay = document.getElementById('maxSlotsDisplay');
      const inventoryGrid = document.getElementById('inventoryGrid');
      const rollCounterDisplay = document.getElementById('rollCounter');
      let isCooldown = false;
      let multiRolls = [];
      let inventory = [];
      let discovered = { ranks: [], specialRanks: [], secretRanks: [], variantSecrets: [], variants: [] };
      let caliCoins = 0;
      let maxSlots = 250;
      let sellExponent = 0.33;
      let rollBulk = 15;
      let variantLuckBonus = 1;
      let availabilityUnlocked = false;
      let totalRolls = 0;
      let calisBlessingActive = false;
      let blessingBoosterActive = false;
      let secretLuckBonus = 1;
      let specialLuckBonus = 1;
      let generalLuckBonus = 1;
      
      let shopUpgrades = {
        variantLuck: 0,
        rollBulk: 0,
        secretLuck: 0,
        specialLuck: 0,
        generalLuck: 0,
        sellPower: 0,
        availability: false,
        calisBlessing: false,
        blessingBooster: false
      };
      
      const MAX_SLOTS = 25;
      let lastClickTime = {};
      let sellMode = false;

      const ALL_RANKS = ['nothing', 'Common', 'Natural', 'Rare', 'Unnatural', 'Epic', 'Decent', 'Mythical', 'Legendary', 'Unreal', 'Super Rare', 'Eternal', 'Starstruck', 'Paradoxical', 'Iridescent', 'Lux', 'Possible', 'RNGesus', 'CRAZY', 'Supreme', 'DAMN', 'Stupiditium', 'ASCENDED', 'Obscure', 'INFINITE', 'Divine', 'Insurmountable', 'GRAND', 'what.', 'FINALE'];
      
      const ALL_SPECIAL_RANKS = ['In im table ?!?!?', '???UNKNOWN???', 'leaflet', 'nil', 'NOTHINGNESS', 'INSANE', 'Lmao', 'PERFECTIONIST', 'Imaginary', 'NICE', 'FUNNY', 'Common : DIVINITY', 'Legacy FINALE', 'Catastrophic', '<(ETERNAL DAWN)>', 'UNOBTAINABLE', 'Everlasting', 'RNGod', 'Invisible', 'cali', 'RNGarbage'];
      
      const ALL_SECRET_RANKS = ['üêü', 'Destiny', 'üå≥', 'ULTIMATE'];
      
      const ALL_VARIANT_SECRETS = ['(Existance)', 'COLOSSAL'];
      
      const ALL_VARIANTS = ['shiny', 'golden', 'inverse', 'retro', 'bright', 'cosmic', 'GIGANTIC', 'h o r s e', 'eternal', 'dark', 'UNIVERSAL', 'Modified', 'Colorful', 'Gigaconfuscibretrationiminousis', 'Possible', 'Gargantuan', 'Ethereal', 'Limitless', 'INFINITUM'];

      function loadDiscovered() {
        const saved = localStorage.getItem('calisRngDiscovered');
        if (saved) {
          try {
            discovered = JSON.parse(saved);
            if (!discovered.secretRanks) discovered.secretRanks = [];
            if (!discovered.variantSecrets) discovered.variantSecrets = [];
          } catch (e) {
            discovered = { ranks: [], specialRanks: [], secretRanks: [], variantSecrets: [], variants: [] };
          }
        }
      }

      function saveDiscovered() {
        localStorage.setItem('calisRngDiscovered', JSON.stringify(discovered));
      }

      function markDiscovered(type, name) {
        if (!discovered[type].includes(name)) {
          discovered[type].push(name);
          saveDiscovered();
        }
      }

      function renderIndex() {
        let html = '<div class="index-category"><h3>Variants</h3>';
        ALL_VARIANTS.forEach(v => {
          const isDiscovered = discovered.variants.includes(v);
          const icon = isDiscovered ? '‚úì' : '‚úó';
          const className = isDiscovered ? 'discovered' : 'undiscovered';
          html += `<div class="index-item ${className}">${icon} ${v}</div>`;
        });
        html += '</div>';

        html += '<div class="index-category"><h3>Variant Secrets</h3>';
        ALL_VARIANT_SECRETS.forEach(r => {
          const isDiscovered = discovered.variantSecrets.includes(r);
          const icon = isDiscovered ? '‚úì' : '‚úó';
          const className = isDiscovered ? 'discovered' : 'undiscovered';
          html += `<div class="index-item ${className}">${icon} ${r}</div>`;
        });
        html += '</div>';

        html += '<div class="index-category"><h3>Special Ranks</h3>';
        ALL_SPECIAL_RANKS.forEach(r => {
          if (r === 'cali' && !availabilityUnlocked) {
            html += `<div class="index-item undiscovered">‚úó ???</div>`;
          } else {
            const isDiscovered = discovered.specialRanks.includes(r);
            const icon = isDiscovered ? '‚úì' : '‚úó';
            const className = isDiscovered ? 'discovered' : 'undiscovered';
            html += `<div class="index-item ${className}">${icon} ${r}</div>`;
          }
        });
        html += '</div>';

        html += '<div class="index-category"><h3>Secret Ranks</h3>';
        ALL_SECRET_RANKS.forEach(r => {
          const isDiscovered = discovered.secretRanks.includes(r);
          const icon = isDiscovered ? '‚úì' : '‚úó';
          const className = isDiscovered ? 'discovered' : 'undiscovered';
          html += `<div class="index-item ${className}">${icon} ${r}</div>`;
        });
        html += '</div>';

        html += '<div class="index-category"><h3>Ranks</h3>';
        ALL_RANKS.forEach(r => {
          const isDiscovered = discovered.ranks.includes(r);
          const icon = isDiscovered ? '‚úì' : '‚úó';
          const className = isDiscovered ? 'discovered' : 'undiscovered';
          html += `<div class="index-item ${className}">${icon} ${r}</div>`;
        });
        html += '</div>';

        indexContent.innerHTML = html;
      }

      toggleInventoryBtn.addEventListener('click', () => {
        if (inventorySection.style.display === 'none') {
          inventorySection.style.display = 'block';
          indexSection.style.display = 'none';
          shopSection.style.display = 'none';
          renderInventory();
        } else {
          inventorySection.style.display = 'none';
        }
      });

      toggleIndexBtn.addEventListener('click', () => {
        if (indexSection.style.display === 'none') {
          indexSection.style.display = 'block';
          inventorySection.style.display = 'none';
          shopSection.style.display = 'none';
          renderIndex();
        } else {
          indexSection.style.display = 'none';
        }
      });

      toggleShopBtn.addEventListener('click', () => {
        if (shopSection.style.display === 'none') {
          shopSection.style.display = 'block';
          inventorySection.style.display = 'none';
          indexSection.style.display = 'none';
          renderShop();
        } else {
          shopSection.style.display = 'none';
        }
      });

      toggleSellModeBtn.addEventListener('click', () => {
        sellMode = !sellMode;
        toggleSellModeBtn.textContent = `Sell Mode: ${sellMode ? 'ON' : 'OFF'}`;
        toggleSellModeBtn.classList.toggle('active', sellMode);
        renderInventory();
      });

      function renderShop() {
        let html = '';
        
        const varCost = Math.floor(100 * Math.pow(1.25, shopUpgrades.variantLuck || 0));
        const varMaxed = (shopUpgrades.variantLuck || 0) >= 20;
        html += `<div class="shop-item">
          <h4>+0.25x Variant Luck</h4>
          <p>Current: ${variantLuckBonus.toFixed(2)}x</p>
          <p>Cost: ${varCost} Cali-coins</p>
          <p>Upgrades: ${shopUpgrades.variantLuck || 0}/20</p>
          ${varMaxed ? '<p class="maxed">MAXED</p>' : `<button onclick="buyUpgrade('variantLuck')" ${caliCoins < varCost || varMaxed ? 'disabled' : ''}>Buy</button>`}
        </div>`;
        
        const bulkCost = Math.floor(50 * Math.pow(1.05, shopUpgrades.rollBulk));
        const bulkMaxed = shopUpgrades.rollBulk >= 35;
        html += `<div class="shop-item">
          <h4>+1 Bulk Roll</h4>
          <p>Current: Roll ${rollBulk} Times</p>
          <p>Cost: ${bulkCost} Cali-coins</p>
          <p>Upgrades: ${shopUpgrades.rollBulk}/35</p>
          ${bulkMaxed ? '<p class="maxed">MAXED</p>' : `<button onclick="buyUpgrade('rollBulk')" ${caliCoins < bulkCost || bulkMaxed ? 'disabled' : ''}>Buy</button>`}
        </div>`;
        
        const secretCost = Math.floor(100 * Math.pow(1.01, shopUpgrades.secretLuck || 0));
        const secretMaxed = (shopUpgrades.secretLuck || 0) >= 280;
        html += `<div class="shop-item">
          <h4>+0.05x Secret Luck</h4>
          <p>Current: ${secretLuckBonus.toFixed(2)}x</p>
          <p>Cost: ${secretCost} Cali-coins</p>
          <p>Upgrades: ${shopUpgrades.secretLuck || 0}/280</p>
          ${secretMaxed ? '<p class="maxed">MAXED</p>' : `<button onclick="buyUpgrade('secretLuck')" ${caliCoins < secretCost || secretMaxed ? 'disabled' : ''}>Buy</button>`}
        </div>`;
        
        const sellCost = Math.floor(1000 * Math.pow(1000, shopUpgrades.sellPower || 0));
        const sellMaxed = (shopUpgrades.sellPower || 0) >= 2;
        html += `<div class="shop-item">
          <h4>+0.33 Sell Exponent</h4>
          <p>Current: ^${sellExponent.toFixed(2)}</p>
          <p>Cost: ${sellCost.toLocaleString()} Cali-coins</p>
          <p>Upgrades: ${shopUpgrades.sellPower || 0}/2</p>
          ${sellMaxed ? '<p class="maxed">MAXED</p>' : `<button onclick="buyUpgrade('sellPower')" ${caliCoins < sellCost || sellMaxed ? 'disabled' : ''}>Buy</button>`}
        </div>`;
        
        const specialCost = Math.floor(100 * Math.pow(1.15, shopUpgrades.specialLuck || 0));
        const specialMaxed = (shopUpgrades.specialLuck || 0) >= 100;
        html += `<div class="shop-item">
          <h4>+0.1x Special Rank Luck</h4>
          <p>Current: ${specialLuckBonus.toFixed(2)}x</p>
          <p>Cost: ${specialCost} Cali-coins</p>
          <p>Upgrades: ${shopUpgrades.specialLuck || 0}/100</p>
          ${specialMaxed ? '<p class="maxed">MAXED</p>' : `<button onclick="buyUpgrade('specialLuck')" ${caliCoins < specialCost || specialMaxed ? 'disabled' : ''}>Buy</button>`}
        </div>`;
        
        const generalCost = Math.floor(100 * Math.pow(1.05, shopUpgrades.generalLuck || 0));
        const generalMaxed = (shopUpgrades.generalLuck || 0) >= 0;
        html += `<div class="shop-item">
          <h4>+0.05x General Luck</h4>
          <p>Current: ${generalLuckBonus.toFixed(2)}x</p>
          <p>Cost: ${generalCost} Cali-coins</p>
          <p>Upgrades: ${shopUpgrades.generalLuck || 0}/1000</p>
          ${generalMaxed ? '<p class="maxed">MAXED</p>' : `<button onclick="buyUpgrade('generalLuck')" ${caliCoins < generalCost || generalMaxed ? 'disabled' : ''}>Buy</button>`}
        </div>`;
        
        html += `<div class="shop-item">
          <h4>Availability</h4>
          <p>Makes ??? rollable</p>
          <p>Cost: 100,000 Cali-coins</p>
          ${shopUpgrades.availability ? '<p class="maxed">PURCHASED</p>' : `<button onclick="buyUpgrade('availability')" ${caliCoins < 100000 || shopUpgrades.availability ? 'disabled' : ''}>Buy</button>`}
        </div>`;
        
        const blessingBonus = calisBlessingActive && totalRolls > 1 ? 
          (blessingBoosterActive ? 
            Math.min(25, Math.pow(Math.log10(totalRolls), 1.15)) : 
            Math.min(5, Math.pow(Math.log10(totalRolls), 0.9))) : 0;
        html += `<div class="shop-item">
          <h4>Cali's Blessing</h4>
          <p>Multiplies all luck by log(rolls)^0.9 (max +5x)</p>
          <p>Current bonus: +${blessingBonus.toFixed(2)}x</p>
          <p>Cost: 777,777 Cali-coins</p>
          ${shopUpgrades.calisBlessing ? '<p class="maxed">PURCHASED</p>' : `<button onclick="buyUpgrade('calisBlessing')" ${caliCoins < 777777 || shopUpgrades.calisBlessing ? 'disabled' : ''}>Buy</button>`}
        </div>`;
        
        html += `<div class="shop-item">
          <h4>'Cali's Blessing' Booster</h4>
          <p>Changes blessing formula to log(rolls)^2</p>
          <p>Increases luck cap to +25x (for EVERYTHING)</p>
          <p>Cost: 10,000,000 Cali-coins</p>
          ${!shopUpgrades.calisBlessing ? '<p style="color: #888;">Requires Cali\'s Blessing</p>' : ''}
          ${shopUpgrades.blessingBooster ? '<p class="maxed">PURCHASED</p>' : `<button onclick="buyUpgrade('blessingBooster')" ${caliCoins < 10000000 || shopUpgrades.blessingBooster || !shopUpgrades.calisBlessing ? 'disabled' : ''}>Buy</button>`}
        </div>`;
        
        shopContent.innerHTML = html;
      }

      window.buyUpgrade = function(type) {
        let cost, maxLevel;
        
        if (type === 'variantLuck') {
          cost = Math.floor(100 * Math.pow(1.25, shopUpgrades.variantLuck || 0));
          maxLevel = 20;
          if (caliCoins >= cost && (shopUpgrades.variantLuck || 0) < maxLevel) {
            caliCoins -= cost;
            shopUpgrades.variantLuck = (shopUpgrades.variantLuck || 0) + 1;
            variantLuckBonus = 1 + (shopUpgrades.variantLuck * 0.25);
          }
        } else if (type === 'rollBulk') {
          cost = Math.floor(50 * Math.pow(1.05, shopUpgrades.rollBulk));
          maxLevel = 35;
          if (caliCoins >= cost && shopUpgrades.rollBulk < maxLevel) {
            caliCoins -= cost;
            shopUpgrades.rollBulk++;
            rollBulk = 15 + shopUpgrades.rollBulk;
          }
        } else if (type === 'secretLuck') {
          cost = Math.floor(100 * Math.pow(1.01, shopUpgrades.secretLuck || 0));
          maxLevel = 280;
          if (caliCoins >= cost && (shopUpgrades.secretLuck || 0) < maxLevel) {
            caliCoins -= cost;
            shopUpgrades.secretLuck = (shopUpgrades.secretLuck || 0) + 1;
            secretLuckBonus = 1 + (shopUpgrades.secretLuck * 0.05);
          }
        } else if (type === 'sellPower') {
          cost = Math.floor(1000 * Math.pow(1000, shopUpgrades.sellPower || 0));
          maxLevel = 2;
          if (caliCoins >= cost && (shopUpgrades.sellPower || 0) < maxLevel) {
            caliCoins -= cost;
            shopUpgrades.sellPower = (shopUpgrades.sellPower || 0) + 1;
            sellExponent = 0.33 + (shopUpgrades.sellPower * 0.33);
          }
        } else if (type === 'specialLuck') {
          cost = Math.floor(100 * Math.pow(1.15, shopUpgrades.specialLuck || 0));
          maxLevel = 100;
          if (caliCoins >= cost && (shopUpgrades.specialLuck || 0) < maxLevel) {
            caliCoins -= cost;
            shopUpgrades.specialLuck = (shopUpgrades.specialLuck || 0) + 1;
            specialLuckBonus = 1 + (shopUpgrades.specialLuck * 0.1);
          }
        } else if (type === 'generalLuck') {
          cost = Math.floor(100 * Math.pow(1.05, shopUpgrades.generalLuck || 0));
          maxLevel = 98000;
          if (caliCoins >= cost && (shopUpgrades.generalLuck || 0) < maxLevel) {
            caliCoins -= cost;
            shopUpgrades.generalLuck = (shopUpgrades.generalLuck || 0) + 1;
            generalLuckBonus = 1 + (shopUpgrades.generalLuck * 0.05);
          }
        } else if (type === 'availability') {
          cost = 100000;
          if (caliCoins >= cost && !shopUpgrades.availability) {
            caliCoins -= cost;
            shopUpgrades.availability = true;
            availabilityUnlocked = true;
          }
        } else if (type === 'calisBlessing') {
          cost = 777777;
          if (caliCoins >= cost && !shopUpgrades.calisBlessing) {
            caliCoins -= cost;
            shopUpgrades.calisBlessing = true;
            calisBlessingActive = true;
          }
        } else if (type === 'blessingBooster') {
          cost = 10000000;
          if (caliCoins >= cost && !shopUpgrades.blessingBooster && shopUpgrades.calisBlessing) {
            caliCoins -= cost;
            shopUpgrades.blessingBooster = true;
            blessingBoosterActive = true;
          }
        }
        
        saveShop();
        renderShop();
      };

      function loadInventory() {
        const saved = localStorage.getItem('calisRngInventory');
        if (saved) {
          try {
            inventory = JSON.parse(saved);
          } catch (e) {
            inventory = [];
          }
        } else {
          inventory = [];
        }
        
        const shopSaved = localStorage.getItem('calisRngShop');
        if (shopSaved) {
          try {
            const shopData = JSON.parse(shopSaved);
            caliCoins = shopData.coins || 0;
            totalRolls = shopData.totalRolls || 0;
            shopUpgrades = shopData.upgrades || { variantLuck: 0, rollBulk: 0, secretLuck: 0, specialLuck: 0, generalLuck: 0, sellPower: 0, availability: false, calisBlessing: false, blessingBooster: false };
            variantLuckBonus = 1 + ((shopUpgrades.variantLuck || 0) * 0.25);
            secretLuckBonus = 1 + ((shopUpgrades.secretLuck || 0) * 0.1);
            specialLuckBonus = 1 + ((shopUpgrades.specialLuck || 0) * 0.1);
            generalLuckBonus = 1 + ((shopUpgrades.generalLuck || 0) * 0.05);
            sellExponent = 0.33 + ((shopUpgrades.sellPower || 0) * 0.33);
            rollBulk = 15 + (shopUpgrades.rollBulk || 0);
            availabilityUnlocked = shopUpgrades.availability || false;
            calisBlessingActive = shopUpgrades.calisBlessing || false;
            blessingBoosterActive = shopUpgrades.blessingBooster || false;
          } catch (e) {
            console.error('Failed to load shop data');
          }
        }
        
        updateCoinsDisplay();
        updateRollCounter();
        renderInventory();
      }

      function saveInventory() {
        localStorage.setItem('calisRngInventory', JSON.stringify(inventory));
        renderInventory();
      }

      function saveShop() {
        const shopData = {
          coins: caliCoins,
          totalRolls: totalRolls,
          upgrades: shopUpgrades
        };
        localStorage.setItem('calisRngShop', JSON.stringify(shopData));
        updateCoinsDisplay();
        updateRollCounter();
        renderShop();
      }

      function updateCoinsDisplay() {
        coinsDisplay.textContent = caliCoins.toFixed(2);
        rollMultipleBtn.textContent = `Roll ${rollBulk} Times`;
      }

      function updateRollCounter() {
        rollCounterDisplay.textContent = totalRolls;
      }

      function renderInventory() {
        inventoryGrid.innerHTML = '';
        inventoryCountDisplay.textContent = inventory.length;
        maxSlotsDisplay.textContent = maxSlots;
        
        for (let i = 0; i < maxSlots; i++) {
          const slot = document.createElement('div');
          slot.className = 'inventory-slot';
          
          if (inventory[i]) {
            const item = inventory[i];
            slot.className = 'inventory-slot';
            
            if (item.variants) {
              const varDiv = document.createElement('div');
              varDiv.className = 'slot-variants';
              varDiv.textContent = item.variants;
              slot.appendChild(varDiv);
            }
            
            const valueDiv = document.createElement('div');
            valueDiv.className = 'slot-value';
            if (item.color.startsWith('linear-gradient')) {
              valueDiv.style.background = item.color;
              valueDiv.style.webkitBackgroundClip = 'text';
              valueDiv.style.webkitTextFillColor = 'transparent';
              valueDiv.style.backgroundClip = 'text';
            } else {
              valueDiv.style.color = item.color;
            }
            valueDiv.textContent = item.displayValue;
            slot.appendChild(valueDiv);
            
            const rankDiv = document.createElement('div');
            rankDiv.className = 'slot-rank';
            rankDiv.textContent = item.rank;
            slot.appendChild(rankDiv);
            
            if (sellMode) {
              slot.onclick = () => sellItem(i);
              slot.style.cursor = 'pointer';
              slot.style.borderColor = '#ff6b35';
            } else {
              slot.onclick = () => deleteItem(i);
            }
          } else {
            slot.className = 'inventory-slot empty';
            slot.textContent = 'Empty';
          }
          
          inventoryGrid.appendChild(slot);
        }
      }

      function sellItem(index) {
        if (!inventory[index]) return;
        const item = inventory[index];
        
        const isNormalRank = ALL_RANKS.includes(item.rank) && 
                            !ALL_SPECIAL_RANKS.includes(item.rank) &&
                            !ALL_VARIANT_SECRETS.includes(item.rank);
        const isSecretRank = ALL_SECRET_RANKS.includes(item.rank);
        
        if (!isNormalRank && !isSecretRank) {
          alert('You can only sell normal ranks and secret ranks!');
          return;
        }
        
        let numericValue = parseFloat(item.displayValue.replace(/,/g, ''));
        if (isNaN(numericValue)) {
          alert('Cannot sell this item!');
          return;
        }
        
        const coins = Math.pow(Math.abs(numericValue), sellExponent);
        caliCoins += coins;
        
        inventory.splice(index, 1);
        saveInventory();
        saveShop();
        
        alert(`Sold for ${coins.toFixed(2)} Cali-coins!`);
      }

      function deleteItem(index) {
        const now = Date.now();
        const key = `slot_${index}`;
        
        if (lastClickTime[key] && now - lastClickTime[key] < 1000) {
          inventory.splice(index, 1);
          saveInventory();
          lastClickTime[key] = 0;
        } else {
          lastClickTime[key] = now;
        }
      }

      function addToInventory(item, buttonId) {
        if (!item) return;
        if (inventory.length >= maxSlots) {
          alert('Inventory full! Delete items or buy more space.');
          return;
        }
        
        inventory.push(item);
        saveInventory();
        
        const btn = document.getElementById(buttonId);
        if (btn) {
          btn.classList.add('accepted');
          btn.onclick = null;
        }
      }

      function acceptRoll(index) {
        addToInventory(multiRolls[index], `rank-btn-${index}`);
      }

      window.acceptRoll = acceptRoll;

      function setCooldown(duration) {
        if (isCooldown) return;
        isCooldown = true;
        rollOnceBtn.disabled = true;
        rollMultipleBtn.disabled = true;
        let remaining = duration / 1000;
        const originalText1 = rollOnceBtn.textContent;
        const originalText2 = rollMultipleBtn.textContent;

        const interval = setInterval(() => {
          rollOnceBtn.textContent = `Cooldown: ${remaining.toFixed(1)}s`;
          rollMultipleBtn.textContent = `Cooldown: ${remaining.toFixed(1)}s`;
          remaining -= 0.1;
          if (remaining <= 0) {
            clearInterval(interval);
            rollOnceBtn.disabled = false;
            rollMultipleBtn.disabled = false;
            rollOnceBtn.textContent = originalText1;
            rollMultipleBtn.textContent = originalText2;
            isCooldown = false;
          }
        }, 100);
      }

      function getColor(value) {
        if (value < 100000) return 'white';
        if (value < 10000000) return 'gold';
        if (value < 1000000000) return 'cyan';
        if (value < 1000000000000) return 'purple';
        if (value < 1000000000000000) return 'green';
        if (value < 1e18) return 'red';
        if (value < 1e21) return 'pink';
        if (value < 1e24) return 'orange';
        if (value < 1e30) return 'linear-gradient(90deg, green, white)';
        if (value < 1e33) return 'linear-gradient(45deg, pink, cyan)';
        if (value < 1e36) return 'linear-gradient(0deg, red, black)';
        if (value < 1e39) return 'linear-gradient(90deg, green, pink)';
        if (value < 1e42) return 'linear-gradient(270deg, red, orange, yellow)';
        if (value < 1e45) return 'linear-gradient(45deg, red, white, cyan)';
        if (value < 1e48) return 'linear-gradient(90deg, white, black, white, black, white, black)';
        if (value < 1e51) return 'linear-gradient(75deg, red, pink, red, pink)';
        if (value < 1e54) return 'linear-gradient(90deg, red, pink, white, pink, red)';
        if (value < 1e57) return 'linear-gradient(150deg, cyan, green, red, white)';
        return 'linear-gradient(90deg, red, orange, yellow, green, cyan, blue, violet)';
      }

      function rollOnce(luckMultiplier = 1, variantLuckMultiplier = 1, secretLuckMultiplier = 1) {
        luckMultiplier *= generalLuckBonus;
        variantLuckMultiplier *= generalLuckBonus;
        secretLuckMultiplier *= generalLuckBonus;
        
        let blessingBonus = 0;
        if (calisBlessingActive && totalRolls > 1) {
          if (blessingBoosterActive) {
            blessingBonus = Math.min(25, Math.pow(Math.log10(totalRolls), 2));
          } else {
            blessingBonus = Math.min(5, Math.pow(Math.log10(totalRolls), 0.9));
          }
        }
        
        luckMultiplier += blessingBonus;
        variantLuckMultiplier += blessingBonus;
        secretLuckMultiplier += blessingBonus;
        
        let isSpecial = false;
        let noCooldownRanks = ['???UNKNOWN???', 'nil', 'Lmao'];
        let originalValue = null;

        // RNGarbage 1/15,629,519
        if (Math.random() < (1 / 15629519) * specialLuckBonus) {
          isSpecial = true;
          markDiscovered('specialRanks', 'RNGarbage');
          const invData = {
            variants: '',
            displayValue: 'Bum..',
            rank: 'RNGarbage',
            color: 'brown'
          };
          return { result: '<span class="bold" style="color: brown;">You rolled a/an RANKBUTTON (Bum..)!</span>', cooldown: 2500, inventoryData: invData };
        }

        // RNGod 1/10,000,000
        if (Math.random() < (1 / 10000000) * specialLuckBonus) {
          isSpecial = true;
          markDiscovered('specialRanks', 'RNGod');
          const invData = {
            variants: '',
            displayValue: '1.0000e+6',
            rank: 'RNGod',
            color: 'gold'
          };
          return { result: '<span class="bold" style="color: gold;">You rolled a/an RANKBUTTON (1.0000e+6)!</span>', cooldown: 5000, inventoryData: invData };
        }

        // Everlasting 1/575,765,100
        if (Math.random() < (1 / 575765100) * luckMultiplier * specialLuckBonus) {
          isSpecial = true;
          markDiscovered('specialRanks', 'Everlasting');
          const invData = {
            variants: '',
            displayValue: '0i',
            rank: 'Everlasting',
            color: 'cyan'
          };
          return { result: '<span class="bold" style="color: cyan;">You rolled a/an RANKBUTTON (0i)!</span>', cooldown: 2500, inventoryData: invData };
        }

        // UNOBTAINABLE 1/1,000,000,000
        if (Math.random() < (1 / 1000000000) * luckMultiplier * specialLuckBonus) {
          isSpecial = true;
          markDiscovered('specialRanks', 'UNOBTAINABLE');
          const invData = {
            variants: '',
            displayValue: '1.0000e+9',
            rank: 'UNOBTAINABLE',
            color: 'red'
          };
          return { result: '<span class="bold" style="color: red;">You rolled a/an RANKBUTTON (1.0000e+9)!</span>', cooldown: 2500, inventoryData: invData };
        }

        // Legacy FINALE 1/25,000,000
        if (Math.random() < (1 / 25000000) * luckMultiplier * specialLuckBonus) {
          isSpecial = true;
          markDiscovered('specialRanks', 'Legacy FINALE');
          const invData = {
            variants: '',
            displayValue: '1.0000e+10',
            rank: 'Legacy FINALE',
            color: 'gold'
          };
          return { result: '<span class="bold" style="color: gold;">You rolled a/an RANKBUTTON (1.0000e+10)!</span>', cooldown: 5000, inventoryData: invData };
        }

        // <(ETERNAL DAWN)> 1/10,000,000
        if (Math.random() < (1 / 10000000) * luckMultiplier * specialLuckBonus) {
          isSpecial = true;
          markDiscovered('specialRanks', '<(ETERNAL DAWN)>');
          const invData = {
            variants: '',
            displayValue: '-777,777,777.78',
            rank: '<(ETERNAL DAWN)>',
            color: 'purple'
          };
          return { result: '<span class="bold" style="color: purple;">You rolled a/an RANKBUTTON (-777,777,777.78)!</span>', cooldown: 4500, inventoryData: invData };
        }

        // Catastrophic 1/390625
        if (Math.random() < (1 / 390625) * specialLuckBonus) {
          isSpecial = true;
          markDiscovered('specialRanks', 'Catastrophic');
          const invData = {
            variants: '',
            displayValue: '-0.50',
            rank: 'Catastrophic',
            color: 'red'
          };
          return { result: '<span class="bold" style="color: red;">You rolled a/an RANKBUTTON (-0.50)!</span>', cooldown: 3500, inventoryData: invData };
        }

        // In im table ?!?!? 1/750k
        if (Math.random() < (1 / 750000) * specialLuckBonus) {
          isSpecial = true;
          markDiscovered('specialRanks', 'In im table ?!?!?');
          const invData = {
            variants: '',
            displayValue: '1einf',
            rank: 'In im table ?!?!?',
            color: 'white'
          };
          return { result: '<span class="bold">You rolled a/an RANKBUTTON (1einf)!</span>', cooldown: 2500, inventoryData: invData };
        }

        // ???UNKNOWN??? 1/1234567 - NO COOLDOWN
        if (Math.random() < (1 / 1234567) * luckMultiplier * specialLuckBonus) {
          isSpecial = true;
          markDiscovered('specialRanks', '???UNKNOWN???');
          const invData = {
            variants: '',
            displayValue: '???',
            rank: '???UNKNOWN???',
            color: 'white'
          };
          return { result: '<span class="bold">You rolled a/an RANKBUTTON (???)!</span>', cooldown: 0, inventoryData: invData };
        }

        // Invisible 1/5,000,000
        if (Math.random() < (1 / 5000000) * specialLuckBonus) {
          isSpecial = true;
          originalValue = Math.random() * 50000;
          markDiscovered('specialRanks', 'Invisible');
          const invData = {
            variants: '',
            displayValue: originalValue.toFixed(2),
            rank: 'Invisible',
            color: 'rgba(255, 192, 203, 0.2)'
          };
          return { result: '<span class="bold" style="color: rgba(255, 192, 203, 0.2);">You rolled a/an RANKBUTTON (' + originalValue.toFixed(2) + ')!</span>', cooldown: 2500, inventoryData: invData };
        }

        // cali 1/10,000,000 (only if availability unlocked)
        if (availabilityUnlocked && Math.random() < (1 / 10000000) * luckMultiplier * specialLuckBonus) {
          isSpecial = true;
          markDiscovered('specialRanks', 'cali');
          const invData = {
            variants: '',
            displayValue: '-1,581,532,333.00',
            rank: 'cali',
            color: 'pink'
          };
          return { result: '<span class="bold" style="color: magenta;">You rolled a/an RANKBUTTON (-1,581,532,333.00)!</span>', cooldown: 5000, inventoryData: invData };
        }

        let base = Math.random();
        let skewed;
        if (base < 0.5) skewed = 1 + Math.random() * 18;
        else if (base < 0.75) skewed = 10 + Math.random() * 180;
        else if (base < 0.90) skewed = 100 + Math.random() * 1800;
        else if (base < 0.97) skewed = 1000 + Math.random() * 18000;
        else if (base < 0.99) skewed = 10000 + Math.random() * 180000;
        else if (base < 0.997) skewed = 100000 + Math.random() * 1800000;
        else if (base < 0.9995) skewed = 1000000 + Math.random() * 18000000;
        else skewed = 10000000 + Math.random() * 1800000000;

        skewed = Math.max(1, skewed);
        if (Math.random() < 1 / 1000) skewed = -1;

        let isNegative = false;
        if (skewed > 1 && Math.random() < 0.075) {
          skewed = -skewed;
          isNegative = true;
        }

        let isReverted = false;
        if (Math.random() < 1 / 75 && skewed !== 0 && skewed !== -1) {
          const originalVal = skewed;
          skewed = 1 / skewed;
          isReverted = true;
          var revertedOriginal = originalVal;
        }

        const baseValue = skewed;
        const absBaseValue = Math.abs(baseValue);
        originalValue = originalValue || baseValue;

        let secretRank = null;
        let secretMultiplier = 1;

        if (Math.random() < (1 / 88888) * secretLuckMultiplier) {
          secretRank = 'ULTIMATE';
          secretMultiplier = 750;
          markDiscovered('secretRanks', 'ULTIMATE');
        } else if (Math.random() < (1 / 40000) * secretLuckMultiplier) {
          secretRank = 'üå≥';
          secretMultiplier = 400;
          markDiscovered('secretRanks', 'üå≥');
        } else if (Math.random() < (1 / 9999) * secretLuckMultiplier) {
          secretRank = 'Destiny';
          secretMultiplier = 99.99;
          markDiscovered('secretRanks', 'Destiny');
        } else if (Math.random() < (1 / 6942) * secretLuckMultiplier) {
          secretRank = 'üêü';
          secretMultiplier = 10;
          markDiscovered('secretRanks', 'üêü');
        }

        const variants = [
          { name: 'shiny', chance: 1 / 100, multiplier: 100 },
          { name: 'Modified', chance: 1 / 250, multiplier: 250 },
          { name: 'golden', chance: 1 / 500, multiplier: 500 },
          { name: 'Colorful', chance: 1 / 777, multiplier: 777 },
          { name: 'inverse', chance: 1 / 1000, multiplier: 1000 },
          { name: 'retro', chance: 1 / 2500, multiplier: 2500 },
          { name: 'bright', chance: 1 / 5000, multiplier: 5000 },
          { name: 'cosmic', chance: 1 / 10000, multiplier: 10000 },
          { name: 'GIGANTIC', chance: 1 / 25000, multiplier: 25000 },
          { name: 'h o r s e', chance: 1 / 30000, multiplier: 1 / 10 },
          { name: 'eternal', chance: 1 / 50000, multiplier: 50000 },
          { name: 'dark', chance: 1 / 77777, multiplier: 77777 },
          { name: 'UNIVERSAL', chance: 1 / 100000, multiplier: 100000 },
          { name: 'Gargantuan', chance: 1 / 300000, multiplier: 300000 },
          { name: 'Possible', chance: 1 / 500000, multiplier: 500000 },
          { name: 'Gigaconfuscibretrationiminousis', chance: 1 / 1000000, multiplier: 1000000 },
          { name: 'Ethereal', chance: 1 / 2500000, multiplier: 2500000 },
          { name: 'Limitless', chance: 1 / 10000000, multiplier: 10000000 },
          { name: 'INFINITUM', chance: 1 / 1e18, multiplier: 1e18 }
        ];

        let variantText = '';
        let variantMultiplier = 1;
        let discoveredVariants = [];

        variants.forEach(v => {
          if (Math.random() < v.chance * variantLuckMultiplier * variantLuckBonus) {
            variantMultiplier *= v.multiplier;
            variantText += `[${v.name.toUpperCase()}] `;
            discoveredVariants.push(v.name);
            markDiscovered('variants', v.name);
          }
        });

        let variantSecret = null;
        let variantSecretMultiplier = 1;
        let removeVariant = null;

        if (discoveredVariants.includes('Gigaconfuscibretrationiminousis')) {
          if (Math.random() < 1 / 2.5) {
            variantSecret = 'COLOSSAL';
            variantSecretMultiplier = 25000000;
            removeVariant = 'Gigaconfuscibretrationiminousis';
            markDiscovered('variantSecrets', 'COLOSSAL');
            isSpecial = true;
          }
        }

        let rank = '';
        let displayValue = baseValue;

        if (Math.random() < 1 / 989000 * specialLuckBonus) { 
          rank = 'INSANE'; 
          displayValue = 0.989; 
          originalValue = 0.989;
          isSpecial = true;
          markDiscovered('specialRanks', 'INSANE');
        }
        else if (Math.random() < 1 / 1500 * specialLuckBonus) { 
          rank = 'Lmao'; 
          displayValue = 0.1;
          originalValue = 0.1;
          isSpecial = true;
          markDiscovered('specialRanks', 'Lmao');
        }
        else if (Math.abs(baseValue - 5000) < 0.01) { 
          rank = 'PERFECTIONIST';
          originalValue = 5000;
          isSpecial = true;
          markDiscovered('specialRanks', 'PERFECTIONIST');
        }
        else if (Math.random() < 1 / 8888 * specialLuckBonus) { 
          rank = "Imaginary"; 
          displayValue = "0.1i";
          originalValue = 0.1;
          isSpecial = true;
          markDiscovered('specialRanks', 'Imaginary');
        }
        else if (baseValue === -1) { 
          if (Math.random() < 1 / 25) {
            rank = 'NOTHINGNESS';
            displayValue = '-error';
            originalValue = -1;
            isSpecial = true;
            markDiscovered('specialRanks', 'NOTHINGNESS');
          } else {
            rank = 'nil';
            originalValue = -1;
            isSpecial = true;
            markDiscovered('specialRanks', 'nil');
          }
        }
        else if (Math.abs(baseValue - 1) < 0.0001) {
          rank = 'nothing';
          markDiscovered('ranks', 'nothing');
        }
        else if (Math.random() < 1 / 69000 * specialLuckBonus) { 
          rank = 'NICE';
          displayValue = 69;
          originalValue = 69;
          isSpecial = true;
          markDiscovered('specialRanks', 'NICE');
        }
        else if (Math.random() < 1 / 694200 * specialLuckBonus) { 
          rank = 'FUNNY';
          displayValue = 69420;
          originalValue = 69420;
          isSpecial = true;
          markDiscovered('specialRanks', 'FUNNY');
        }
        else if (absBaseValue < 5) {
          if (Math.random() < 1 / 33333 * specialLuckBonus) { 
            rank = 'Common : DIVINITY'; 
            displayValue *= 5e5;
            isSpecial = true;
            markDiscovered('specialRanks', 'Common : DIVINITY');
          }
          else { 
            rank = 'Common';
            markDiscovered('ranks', 'Common');
          }
        }
        else if (absBaseValue < 25) { rank = 'Natural'; markDiscovered('ranks', 'Natural'); }
        else if (absBaseValue < 50) { rank = 'Rare'; markDiscovered('ranks', 'Rare'); }
        else if (absBaseValue < 100) { rank = 'Unnatural'; markDiscovered('ranks', 'Unnatural'); }
        else if (absBaseValue < 250) { rank = 'Epic'; markDiscovered('ranks', 'Epic'); }
        else if (absBaseValue < 500) { rank = 'Decent'; markDiscovered('ranks', 'Decent'); }
        else if (absBaseValue < 1000) { rank = 'Mythical'; markDiscovered('ranks', 'Mythical'); }
        else if (absBaseValue < 5000) { rank = 'Legendary'; markDiscovered('ranks', 'Legendary'); }
        else if (absBaseValue < 10000) { rank = 'Unreal'; markDiscovered('ranks', 'Unreal'); }
        else if (absBaseValue < 50000) { rank = 'Super Rare'; markDiscovered('ranks', 'Super Rare'); }
        else if (absBaseValue < 100000) { rank = 'Eternal'; markDiscovered('ranks', 'Eternal'); }
        else if (absBaseValue < 500000) { rank = 'Starstruck'; markDiscovered('ranks', 'Starstruck'); }
        else if (absBaseValue < 1000000) { rank = 'Paradoxical'; markDiscovered('ranks', 'Paradoxical'); }
        else if (absBaseValue < 5000000) { rank = 'Iridescent'; markDiscovered('ranks', 'Iridescent'); }
        else if (absBaseValue < 10000000) { rank = 'Lux'; markDiscovered('ranks', 'Lux'); }
        else if (absBaseValue < 50000000) { rank = 'Possible'; markDiscovered('ranks', 'Possible'); }
        else if (absBaseValue < 100000000) { rank = 'RNGesus'; markDiscovered('ranks', 'RNGesus'); }
        else if (absBaseValue < 250000000) { rank = 'CRAZY'; markDiscovered('ranks', 'CRAZY'); }
        else if (absBaseValue < 1000000000) { rank = 'Supreme'; markDiscovered('ranks', 'Supreme'); }
        else if (absBaseValue < 1e10) { rank = 'DAMN'; markDiscovered('ranks', 'DAMN'); }
        else if (absBaseValue < 1e12) { rank = 'Stupiditium'; markDiscovered('ranks', 'Stupiditium'); }
        else if (absBaseValue < 1e15) { rank = 'ASCENDED'; markDiscovered('ranks', 'ASCENDED'); }
        else if (absBaseValue < 1e18) { rank = 'Obscure'; markDiscovered('ranks', 'Obscure'); }
        else if (absBaseValue < 1e21) { rank = 'INFINITE'; markDiscovered('ranks', 'INFINITE'); }
        else if (absBaseValue < 1e30) { rank = 'Divine'; markDiscovered('ranks', 'Divine'); }
        else if (absBaseValue < 1e50) { rank = 'Insurmountable'; markDiscovered('ranks', 'Insurmountable'); }
        else if (absBaseValue < 1e75) { rank = 'GRAND'; markDiscovered('ranks', 'GRAND'); }
        else if (absBaseValue < 1e100) { rank = 'what.'; markDiscovered('ranks', 'what.'); }
        else { rank = 'FINALE'; markDiscovered('ranks', 'FINALE'); }

        if (Math.random() < (1 / 2763000) * luckMultiplier * specialLuckBonus) {
          isSpecial = true;
          rank = 'leaflet';
          displayValue = 2763;
          originalValue = 2763;
          markDiscovered('specialRanks', 'leaflet');
        }

        let dispValue;
        if (isSpecial && !['leaflet', 'Common : DIVINITY'].includes(rank) && originalValue !== null) {
          if (typeof originalValue === 'number') {
            if (Math.abs(originalValue) >= 1e12) {
              dispValue = originalValue.toExponential(4);
            } else if (Math.abs(originalValue) >= 1000) {
              dispValue = originalValue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            } else {
              dispValue = originalValue.toFixed(2);
            }
          } else {
            dispValue = originalValue;
          }
        } else if (typeof displayValue === 'number') {
          if (isReverted) {
            const exponent = Math.floor(Math.log10(Math.abs(displayValue)));
            const mantissa = Math.abs(displayValue) / Math.pow(10, exponent);
            dispValue = `${mantissa.toFixed(2)}e${exponent}`;
          } else if (Math.abs(displayValue) >= 1e12) {
            dispValue = displayValue.toExponential(4);
          } else if (Math.abs(displayValue) >= 1000) {
            dispValue = displayValue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
          } else {
            dispValue = displayValue.toFixed(2);
          }
        } else {
          dispValue = displayValue;
        }

        if (typeof displayValue !== 'string' && variantMultiplier !== 1) {
          displayValue = displayValue * variantMultiplier;
        }

        if (secretRank && typeof displayValue === 'number') {
          displayValue = displayValue * secretMultiplier;
        }

        if (variantSecret && typeof displayValue === 'number') {
          displayValue = displayValue * variantSecretMultiplier;
        }

        const absDisplayValue = typeof displayValue === 'number' ? Math.abs(displayValue) : 0;

        if (typeof displayValue === 'number') {
          if (isReverted) {
            const exponent = Math.floor(Math.log10(Math.abs(displayValue)));
            const mantissa = Math.abs(displayValue) / Math.pow(10, exponent);
            dispValue = `${mantissa.toFixed(2)}e${exponent}`;
          } else if (Math.abs(displayValue) >= 1e12) {
            dispValue = displayValue.toExponential(4);
          } else if (Math.abs(displayValue) >= 1000) {
            dispValue = displayValue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
          } else {
            dispValue = displayValue.toFixed(2);
          }
        }

        let result = '';
        let invVariants = '';
        
        if (removeVariant) {
          const removeIndex = discoveredVariants.indexOf(removeVariant);
          if (removeIndex > -1) {
            discoveredVariants.splice(removeIndex, 1);
          }
          variantText = '';
          discoveredVariants.forEach(v => {
            variantText += `[${v.toUpperCase()}] `;
          });
        }
        
        if (variantText) {
          result += variantText;
          invVariants = variantText.trim();
        }
        if (variantSecret) {
          result += `<${variantSecret}> `;
          if (invVariants) invVariants += ' ';
          invVariants += `<${variantSecret}>`;
        }
        if (secretRank) {
          result += `{${secretRank}} `;
          if (invVariants) invVariants += ' ';
          invVariants += `{${secretRank}}`;
        }
        if (isNegative) result += '[NEGATIVE] ';
        if (isReverted) result += '[REVERTED] ';
        const color = getColor(absDisplayValue);

        const rankButton = `<button class="rank-button" id="rank-btn-ROLLINDEX" onclick="acceptRoll(ROLLINDEX)">${rank}</button>`;

        if (['Lmao','FUNNY','NICE','nil','NOTHINGNESS','PERFECTIONIST','In im table ?!?!?','INSANE','Common : DIVINITY','Imaginary','???UNKNOWN???','Legacy FINALE','Catastrophic','<(ETERNAL DAWN)>','UNOBTAINABLE','Everlasting','RNGod','Invisible','cali','RNGarbage','leaflet'].includes(rank)) {
          if (color.startsWith('linear-gradient')) {
            result += `<span class="bold" style="background: ${color}; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">You rolled a/an RANKBUTTON (${dispValue})!</span>`;
          } else {
            result += `<span class="bold" style="color:${color};">You rolled a/an RANKBUTTON (${dispValue})!</span>`;
          }
        } else {
          if (color.startsWith('linear-gradient')) {
            result += `<span style="background: ${color}; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">You rolled a/an ${dispValue} RANKBUTTON!</span>`;
          } else {
            result += `<span style="color:${color};">You rolled a/an ${dispValue} RANKBUTTON!</span>`;
          }
        }

        let cooldown = 0;
        if (isSpecial && !noCooldownRanks.includes(rank)) {
          cooldown = 500;
        } else if (absDisplayValue >= 1e39) {
          cooldown = 1500;
        }

        const inventoryData = {
          variants: invVariants,
          displayValue: dispValue,
          rank: rank,
          color: color
        };

        return { result, cooldown, inventoryData };
      }

      rollOnceBtn.addEventListener('click', () => {
        if (isCooldown) return;
        multiRolls = [];
        totalRolls++;
        saveShop();
        const roll = rollOnce(250, 33, 11.11 * secretLuckBonus);
        multiRolls.push(roll.inventoryData);
        
        let displayResult = roll.result.replace(/ROLLINDEX/g, '0').replace(/RANKBUTTON/g, roll.inventoryData ? 
          `<button class="rank-button" id="rank-btn-0" onclick="acceptRoll(0)">${roll.inventoryData.rank}</button>` : 
          roll.inventoryData ? roll.inventoryData.rank : '???');
        
        resultsDiv.innerHTML = displayResult;
        if (roll.cooldown > 0) setCooldown(roll.cooldown);
      });

      rollMultipleBtn.addEventListener('click', () => {
        if (isCooldown) return;
        let maxCooldown = 0;
        let output = '';
        multiRolls = [];
        
        for (let i = 0; i < rollBulk; i++) {
          totalRolls++;
          const roll = rollOnce(11.11, 11.11, 5 * secretLuckBonus);
          multiRolls.push(roll.inventoryData);
          
          let displayResult = roll.result.replace(/ROLLINDEX/g, i.toString()).replace(/RANKBUTTON/g, roll.inventoryData ? 
            `<button class="rank-button" id="rank-btn-${i}" onclick="acceptRoll(${i})">${roll.inventoryData.rank}</button>` : 
            '???');
          
          output += `<div class="roll-line">${displayResult}</div>`;
          if (roll.cooldown > maxCooldown) maxCooldown = roll.cooldown;
        }
        
        saveShop();
        resultsDiv.innerHTML = output;
        if (maxCooldown > 0) setCooldown(maxCooldown);
      });

      window.acceptRoll = acceptRoll;

      loadDiscovered();
      loadInventory();
    </script>
  </body>
</html>
